<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Planet Lead Pull — Start a Scrape</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box }
    html, body { height: 100%; overflow-x: hidden; }
    body {
      margin: 0; padding: 32px;
      font: 14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial;
      color: var(--fg); background: var(--bg);
    }
    :root, .t-aurora {
      --bg:#0b0f12; --panel:#0f151b; --panel2:#0d1318; --hdr:#0b1014;
      --fg:#e8eef6; --muted:#9fb0c2; --line:#1b2631; --chip:#0f151b; --chip-b:#243240; --input:#0e1419;
      --c-info:#86b7ff; --c-err:#ff7b7b; --ok:#8fffa0;
    }
    .t-aurora::before{content:"";position:fixed;inset:0;pointer-events:none;opacity:.25;mix-blend-mode:soft-light;
      background: radial-gradient(60% 60% at 20% 0%, rgba(150,220,255,.18), transparent 60%),
                  radial-gradient(60% 60% at 100% 30%, rgba(255,180,120,.10), transparent 60%);
      filter: blur(22px);
    }

    .wrap{max-width:1120px;margin:0 auto}
    .grid{display:grid;grid-template-columns: 1.3fr .9fr;gap:22px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--line); border-radius:14px; padding:20px;
      box-shadow: 0 20px 50px rgba(0,0,0,.35);
    }
    .card header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--line)}
    .brand{font-weight:800}
    .sub{color:var(--muted)}

    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input, select{
      width:100%;padding:10px 12px;font-size:14px;color:var(--fg);
      background:var(--input);border:1px solid var(--chip-b);border-radius:10px;outline:none;
    }
    input:focus, select:focus{ border-color: var(--c-info); box-shadow: 0 0 0 2px color-mix(in oklab, var(--c-info) 25%, transparent) inset }

    /* Max Leads row: single column so placeholder fits; keep label on one line */
    .row2{display:grid;grid-template-columns:1fr;gap:14px}
    label[for="m"]{white-space:nowrap}

    .actions{display:flex;gap:12px;align-items:center;margin-top:16px}
    button{
      padding:10px 14px;border-radius:10px;border:1px solid var(--chip-b);
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 85%, #000 15%), var(--panel));
      color:var(--fg);cursor:pointer;font-weight:600;
    }
    button:hover{border-color:var(--c-info)}
    .note{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--c-err)}

    /* ===== Badge panel ===== */
    .panel h2{margin:0 0 10px;font-size:15px;letter-spacing:.2px;display:flex;align-items:center;gap:8px}
    .tooltip{position:relative;display:inline-block}
    .hint{display:inline-grid;place-items:center;width:18px;height:18px;border-radius:50%;border:1px solid var(--chip-b);
      color:var(--muted);font-weight:700;font-size:12px;cursor:pointer;user-select:none}
    .tip{display:none;position:absolute;left:24px;top:-4px;z-index:10;min-width:260px;max-width:420px;
      background:#0c1218;border:1px solid var(--line);border-radius:10px;padding:10px;color:var(--muted);font-size:12px;
      box-shadow:0 8px 28px rgba(0,0,0,.35)}
    .tooltip.show .tip{display:block}

    /* grid: dot | name | on | mode | range */
    .b-head,.b-row{
      display:grid;
      grid-template-columns: 24px 1fr 74px 180px minmax(360px, 1fr);
      gap:12px;align-items:center
    }
    .b-head{color:var(--muted);font-size:12px;margin-bottom:6px}
    .b-head > div:nth-child(1), .b-head > div:nth-child(2){ text-align:left }
    .b-head > div:nth-child(3), .b-head > div:nth-child(4), .b-head > div:nth-child(5){ text-align:center }
    .b-row{margin-bottom:8px}

    .name{display:flex;align-items:center;gap:10px;font-weight:700}
    .handle{display:none; cursor:grab; color:var(--muted); user-select:none}
    .drag-mode .handle{display:inline-block}
    .drag-mode .b-row{border:1px dashed #223045;border-radius:10px;padding:6px}
    .drag-hover{outline:1px solid #2b4058}

    .dot{width:8px;height:8px;border-radius:50%}
    .dot.star{background:#ffd27a}.dot.white{background:#e8eef6}.dot.purple{background:#f6b4ff}.dot.orange{background:#ffd27a}.dot.red{background:#ff7b7b}

    .sw{position:relative;display:inline-block;width:40px;height:22px;margin:0 auto}
    .sw input{display:none}
    .knob{position:absolute;cursor:pointer;inset:0;background:#0f151b;border:1px solid var(--chip-b);border-radius:999px;transition:.2s}
    .knob::after{content:"";position:absolute;width:18px;height:18px;border-radius:50%;left:2px;top:2px;background:#6b7c8e;transition:.2s}
    .sw input:checked + .knob{background:#0f1c2a;border-color:#2d4663}
    .sw input:checked + .knob::after{transform:translateX(18px);background:#9fd0ff}

    .mode{width:180px;margin:0 auto}

    .range{display:flex;gap:10px;align-items:center;justify-content:center}
    .range input{
      flex:1 1 0; min-width:140px; max-width:220px; text-align:right;
      font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace
    }
    .range.disabled{opacity:.55;pointer-events:none}
    .sep{color:var(--muted)}

    .prio-controls{display:none;gap:8px;margin-top:8px}
    .drag-mode + .prio-controls{display:flex}
  </style>
</head>
<body class="t-aurora">
  <div class="wrap">
    <div class="grid">
      <!-- Left: Credentials -->
      <section class="card">
        <header>
          <div class="brand">OP: PLANET LEAD PULL</div>
          <div class="sub">Start a scrape</div>
        </header>

        <p class="sub">Enter credentials for this run. Your lead pull will auto-start and you will be navigated to your private live stream.</p>

        <form id="f" autocomplete="on">
          <label for="u">Username</label>
          <input id="u" autocomplete="username" required />

          <label for="p">Password</label>
          <input id="p" type="password" autocomplete="current-password" required />

          <label for="e">Report email (where the sheet is shared)</label>
          <input id="e" type="email" autocomplete="email" required />

          <div class="row2">
            <div>
              <label for="m">Max leads (optional)</label>
              <input id="m" type="number" min="1" step="1" placeholder="Default: 500" />
            </div>
          </div>

          <div class="actions">
            <button type="submit">Start Run</button>
            <span id="status" class="note"></span>
          </div>

          <p class="note" style="margin-top:10px">After submit, you’ll be redirected to <code>/live?job=…</code>.</p>
        </form>
      </section>

      <!-- Right: Badge panel -->
      <aside class="card panel" id="badgePanel">
        <h2>
          Badges
          <span class="tooltip" id="badgeHelp">
            <span class="hint">?</span>
            <span class="tip">
              <b>Modes:</b> <i>Premium Range</i> uses the amount range; <i>Invalid Number</i> and <i>Lapsed</i> ignore amounts (Lapsed wins over Invalid Number).<br/>
              <b>Range:</b> leave blank if you don’t want a bound.<br/>
              <b>Priority:</b> click <i>Change Priority</i> to drag badges (top has highest precedence).
            </span>
          </span>
        </h2>

        <div class="b-head">
          <div></div><div>Badge</div><div>On</div><div>Mode</div><div>Range</div>
        </div>
        <div id="bRows"></div>

        <div class="actions prio-controls" id="prioControls">
          <button id="prioDone" type="button">Done</button>
          <button id="prioCancel" type="button">Cancel</button>
        </div>

        <div class="actions" style="margin-top:10px">
          <button id="prioBtn" type="button">Change Priority</button>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const status = $('#status');

    // Tooltip
    (() => {
      const t = $('#badgeHelp');
      t.addEventListener('click', () => t.classList.toggle('show'));
      document.addEventListener('click', e => { if (!t.contains(e.target)) t.classList.remove('show'); });
    })();

    // Config
    let BADGE_ORDER = ['star','white','purple','orange','red'];   // mutable in drag mode
    const DEFAULT_FALLBACK = 'white';
    const MODE = { NUMBER:'NUMBER', LAPSED:'LAPSED', NO_NUMBERS:'NO_NUMBERS' };
    const MODE_LABEL = { NUMBER: 'Premium Range', NO_NUMBERS: 'Invalid Number', LAPSED: 'Lapsed' };

    const LABEL = {
      star:   { txt:'Star',   dot:'star',   emoji:'⭐' },
      white:  { txt:'White',  dot:'white',  emoji:'⚪' },
      purple: { txt:'Purple', dot:'purple', emoji:'🟣' },
      orange: { txt:'Orange', dot:'orange', emoji:'🟠' },
      red:    { txt:'Red',    dot:'red',    emoji:'🔴' },
    };

    // money helpers
    const parseMoney = (s) => {
      if (s == null) return null;
      const t = String(s).trim();
      if (!t) return null;
      const n = Number(t.replace(/[^\d.]/g, ''));
      return Number.isFinite(n) ? Math.round(n * 100) / 100 : null;
    };
    const toDollar = n => (Number.isFinite(n) ? ('$' + n.toFixed(2)) : '');

    // Badge rows
    const bRows = $('#bRows');
    function mkRow(kind){
      const r = document.createElement('div');
      r.className = 'b-row';
      r.dataset.kind = kind;

      const dot = document.createElement('span');
      dot.className = 'dot ' + LABEL[kind].dot;

      const name = document.createElement('div');
      name.className = 'name';
      name.innerHTML = `<span class="handle">☰</span>${LABEL[kind].emoji} ${LABEL[kind].txt}`;

      const sw = document.createElement('label');
      sw.className = 'sw';
      sw.innerHTML = `<input type="checkbox" checked><span class="knob"></span>`;

      const mode = document.createElement('select');
      mode.className = 'mode';
      mode.innerHTML = `
        <option value="${MODE.NUMBER}">${MODE_LABEL.NUMBER}</option>
        <option value="${MODE.NO_NUMBERS}">${MODE_LABEL.NO_NUMBERS}</option>
        <option value="${MODE.LAPSED}">${MODE_LABEL.LAPSED}</option>
      `;

      const range = document.createElement('div');
      range.className = 'range';
      range.innerHTML = `
        <input type="text" class="floor" placeholder="" inputmode="decimal" autocomplete="off" data-touched="false" />
        <span class="sep">to</span>
        <input type="text" class="ceil"  placeholder="" inputmode="decimal" autocomplete="off" data-touched="false" />
      `;

      const floor = range.querySelector('.floor');
      const ceil  = range.querySelector('.ceil');

      const onFocus = inp => { const v = parseMoney(inp.value); inp.value = (v==null ? '' : String(v)); };
      const onBlur  = inp => {
        const v = parseMoney(inp.value);
        if (v==null){ inp.value=''; inp.dataset.touched='false'; }
        else { inp.value = toDollar(v); inp.dataset.touched='true'; }
      };
      [floor, ceil].forEach(inp=>{
        inp.addEventListener('focus', ()=>onFocus(inp));
        inp.addEventListener('blur',  ()=>onBlur(inp));
        inp.addEventListener('input', ()=>{ inp.dataset.touched = inp.value.trim()!=='' ? 'true' : 'false'; });
      });

      const sync = () => {
        const on  = sw.querySelector('input').checked;
        const isN = mode.value === MODE.NUMBER;
        range.classList.toggle('disabled', !(on && isN));
      };
      sw.querySelector('input').addEventListener('change', sync);
      mode.addEventListener('change', sync);

      r._refs = { on: sw.querySelector('input'), mode, floor, ceil, range };
      r.append(dot, name, sw, mode, range);
      return r;
    }

    BADGE_ORDER.forEach(k => bRows.appendChild(mkRow(k)));

    // Defaults
    (function setDefaults(){
      const row = k => $$('.b-row').find(x => x.dataset.kind===k)._refs;
      const set = (k,{on=true,mode, floor, ceil})=>{
        const r=row(k);
        r.on.checked = on;
        r.mode.value = mode;
        if (mode===MODE.NUMBER){
          if (floor!=null){ r.floor.value=toDollar(Number(floor)); r.floor.dataset.touched='true'; }
          if (ceil !=null){ r.ceil.value =toDollar(Number(ceil));   r.ceil.dataset.touched='true'; }
          if (ceil==null){ r.ceil.value=''; r.ceil.dataset.touched='false'; }
        }else{
          r.floor.value=''; r.ceil.value='';
          r.floor.dataset.touched=r.ceil.dataset.touched='false';
        }
        r.range.classList.toggle('disabled', !(r.on.checked && r.mode.value===MODE.NUMBER));
      };
      set('star',   { mode:MODE.NUMBER,    floor:100,  ceil:null   });
      set('white',  { mode:MODE.NUMBER,    floor:50,   ceil:99.99 });
      set('purple', { mode:MODE.NUMBER,    floor:0.01, ceil:49.99 });
      set('orange', { mode:MODE.NO_NUMBERS });
      set('red',    { mode:MODE.LAPSED });
    })();

    // ===== Drag reordering on the rows themselves =====
    const panel = $('#badgePanel');
    const prioBtn = $('#prioBtn');
    const prioControls = $('#prioControls');
    let snapshotOrder = [];

    function getCurrentOrderFromDOM(){ return $$('#bRows .b-row').map(r=>r.dataset.kind); }
    function applyOrder(order){
      const frag = document.createDocumentFragment();
      order.forEach(k => frag.appendChild($(`#bRows .b-row[data-kind="${k}"]`)));
      $('#bRows').appendChild(frag);
    }

    function enterDragMode(){
      snapshotOrder = getCurrentOrderFromDOM();
      panel.classList.add('drag-mode');
      prioBtn.textContent = 'Finish Reordering';
      prioControls.style.display = 'flex';
      $$('#bRows .b-row').forEach(row=>{
        row.draggable = true;
        row.addEventListener('dragstart', onDragStart);
        row.addEventListener('dragover', onDragOver);
        row.addEventListener('dragleave', onDragLeave);
        row.addEventListener('drop', onDrop);
        row.addEventListener('dragend', onDragEnd);
      });
    }
    function exitDragMode(save=true){
      if(!save){ applyOrder(snapshotOrder); }
      panel.classList.remove('drag-mode');
      prioBtn.textContent = 'Change Priority';
      prioControls.style.display = 'none';
      $$('#bRows .b-row').forEach(row=>{
        row.draggable = false;
        row.removeEventListener('dragstart', onDragStart);
        row.removeEventListener('dragover', onDragOver);
        row.removeEventListener('dragleave', onDragLeave);
        row.removeEventListener('drop', onDrop);
        row.removeEventListener('dragend', onDragEnd);
        row.classList.remove('drag-hover');
      });
      // Save final order
      BADGE_ORDER = getCurrentOrderFromDOM();
    }

    let dragEl=null;
    function onDragStart(e){ dragEl = e.currentTarget; e.dataTransfer.effectAllowed='move'; }
    function onDragOver(e){
      e.preventDefault();
      const tgt = e.currentTarget;
      if (tgt===dragEl) return;
      const rect = tgt.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      tgt.classList.add('drag-hover');
      $('#bRows').insertBefore(dragEl, before ? tgt : tgt.nextSibling);
    }
    function onDragLeave(e){ e.currentTarget.classList.remove('drag-hover'); }
    function onDrop(e){ e.preventDefault(); e.currentTarget.classList.remove('drag-hover'); }
    function onDragEnd(){ dragEl=null; }

    // Toggle with the same button
    prioBtn.addEventListener('click', ()=>{
      if (!panel.classList.contains('drag-mode')) enterDragMode();
      else exitDragMode(true);  // clicking again saves & exits
    });
    $('#prioCancel').addEventListener('click', ()=> exitDragMode(false));
    $('#prioDone').addEventListener('click',   ()=> exitDragMode(true));

    // ===== Build badgeConfig & submit =====
    function buildBadgeConfig(){
      const rows = BADGE_ORDER.map(k => {
        const n = $$('.b-row').find(x => x.dataset.kind===k)._refs;
        return { kind:k, ...n };
      });

      const raw = rows.map(({kind,on,mode,floor,ceil}) => ({
        kind,
        on: !!on.checked,
        mode: mode.value,
        floor: (floor.dataset.touched==='true') ? parseMoney(floor.value) : null,
        ceil:  (ceil.dataset.touched==='true')  ? parseMoney(ceil.value)  : null,
      }));

      const numerics = raw.filter(r => r.on && r.mode===MODE.NUMBER);
      let lastHigherFloor = null;
      for (let i=0;i<numerics.length;i++){
        const r = numerics[i];
        if (i===0){ lastHigherFloor = r.floor ?? lastHigherFloor; continue; }
        if (r.ceil==null && lastHigherFloor!=null){
          r.ceil = Math.round((lastHigherFloor - 0.01) * 100) / 100;
        }
        if (r.floor!=null) lastHigherFloor = r.floor;
      }

      const rules = {};
      for (const r of raw){
        rules[r.kind] = {
          on:   r.on,
          mode: r.mode,
          floor: r.mode===MODE.NUMBER ? (r.floor ?? null) : null,
          ceil:  r.mode===MODE.NUMBER ? (r.ceil  ?? null) : null,
        };
      }
      return {
        order: [...BADGE_ORDER],
        defaultFallback: DEFAULT_FALLBACK,
        priority: { lapsedFirst: true },
        rules
      };
    }

    $('#f').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      status.textContent = 'Creating job…';
      try {
        const badgeConfig = buildBadgeConfig();
        const maxField = ($('#m').value || '').trim();
        const payload = {
          username: $('#u').value.trim(),
          password: $('#p').value,
          email:    $('#e').value.trim(),
          max:      (maxField === '' ? 500 : Number(maxField)),
          autoStart: true,
          badgeConfig
        };

        const res = await fetch('/session', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text().catch(()=>('HTTP '+res.status)));
        const data = await res.json();
        const liveUrl = data.liveUrl || `/live?job=${encodeURIComponent(data.jobId)}`;

        status.innerHTML = '<span class="ok">Job created.</span> Opening live…';
        setTimeout(() => location.href = liveUrl, 350);
      } catch (err) {
        console.error(err);
        status.innerHTML = `<span class="err">Error:</span> ${err.message || err}`;
      }
    });
  </script>
</body>
</html>
