<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Live Intake</title>
  <style>
    :root{
      --bg:#0e1217;
      --panel:#161b22;
      --text:#d8dee9;
      --muted:#8b95a7;
      --ok:#58a6ff;         /* info */
      --lead:#7ee787;       /* lead */
      --sheet:#f2cc60;      /* sheet */
      --err:#ff7b72;        /* error */
      --done:#a78bfa;       /* done */
      --number:#5ac8fa;     /* numbers */
      --badge:#f6c177;      /* badge */
      --pulse:#8b95a7;      /* pulse (muted) */
      --chip-bg:#0f141a;
      --chip-br:#223040;
      --ok-bg:#0a2642;
      --lead-bg:#0f2414;
      --sheet-bg:#2a2310;
      --err-bg:#2a1210;
      --done-bg:#1f1630;
      --number-bg:#0b2230;
      --badge-bg:#2a2212;
      --pulse-bg:#12161c;
    }
    *{ box-sizing:border-box; }
    html, body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .wrap{ max-width: 1100px; margin:32px auto; padding:0 16px; }
    .bar{ display:flex; align-items:center; gap:10px; margin-bottom:12px; }
    .circle{ width:10px; height:10px; border-radius:50%; background:#22c55e; box-shadow:0 0 12px rgba(34,197,94,.45); }
    .card{ background:var(--panel); border:1px solid #222a36; border-radius:14px; padding:10px; }
    .legend{ display:flex; gap:8px; margin-left:auto; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:2px 10px; border-radius:999px; border:1px solid var(--chip-br); background:var(--chip-bg); color:var(--muted); font-size:12px; line-height:18px; }
    .pill .dot{ width:6px; height:6px; border-radius:50%; }

    /* Per-type coloring */
    .pill.info   { color:var(--ok);    background:var(--ok-bg);    border-color:rgba(88,166,255,.25) }
    .pill.lead   { color:var(--lead);  background:var(--lead-bg);  border-color:rgba(126,231,135,.20) }
    .pill.sheet  { color:var(--sheet); background:var(--sheet-bg); border-color:rgba(242,204,96,.20) }
    .pill.error  { color:var(--err);   background:var(--err-bg);   border-color:rgba(255,123,114,.20) }
    .pill.done   { color:var(--done);  background:var(--done-bg);  border-color:rgba(167,139,250,.20) }
    .pill.numbers{ color:var(--number);background:var(--number-bg);border-color:rgba(90,200,250,.20) }
    .pill.badge  { color:var(--badge); background:var(--badge-bg); border-color:rgba(246,193,119,.20) }
    .pill.pulse  { color:var(--pulse); background:var(--pulse-bg); border-color:rgba(139,149,167,.20) }

    .rows{ display:grid; grid-template-columns: 96px 96px 1fr; gap:0; }
    .row{ display:contents; }
    .cell{ padding:8px 10px; border-top:1px solid #1f2633; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .cell.type{ white-space:unset; }
    .cell.msg { white-space:unset; }
    .header .cell{ border-top:none; color:var(--muted); font-size:12px; letter-spacing:.02em; }
    .clock{ font-variant-numeric: tabular-nums; color:#a7b3c6; }

    .status{ display:flex; align-items:center; gap:8px; margin-bottom:8px; color:var(--muted); font-size:12px; }
    .status .state{ font-weight:600; color:var(--text); }

    .empty{ color:var(--muted); text-align:center; padding:16px 0; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="circle" id="lamp" title="Connected"></div>
      <div class="status">Connected <span class="state" id="state">connecting…</span></div>
      <div class="legend">
        <span class="pill info"><span class="dot" style="background:var(--ok)"></span>info</span>
        <span class="pill lead"><span class="dot" style="background:var(--lead)"></span>lead</span>
        <span class="pill sheet"><span class="dot" style="background:var(--sheet)"></span>sheet</span>
        <span class="pill error"><span class="dot" style="background:var(--err)"></span>error</span>
        <span class="pill done"><span class="dot" style="background:var(--done)"></span>done</span>
        <span class="pill numbers"><span class="dot" style="background:var(--number)"></span>numbers</span>
        <span class="pill badge"><span class="dot" style="background:var(--badge)"></span>badge</span>
        <span class="pill pulse"><span class="dot" style="background:var(--pulse)"></span>● pulse</span>
      </div>
    </div>

    <div class="card">
      <div class="rows header">
        <div class="cell clock">time</div>
        <div class="cell type">type</div>
        <div class="cell msg">message</div>
      </div>
      <div class="rows" id="rows"></div>
      <div id="empty" class="empty">Waiting for events…</div>
    </div>
  </div>

  <script>
    // ===== Config
    const ENDPOINT = '/events';
    const MAX_BACKOFF = 15_000;

    // ===== State
    let es = null;
    let backoff = 500;
    let lastPulseMs = 0;

    const qs  = (s,el=document)=>el.querySelector(s);
    const rowsEl = qs('#rows');
    const stateEl = qs('#state');
    const emptyEl = qs('#empty');
    const lampEl  = qs('#lamp');

    // ===== Utils
    const pad2 = n => (n<10 ? '0'+n : ''+n);
    function mmss(tsMs) {
      const d = new Date(tsMs);
      return pad2(d.getMinutes()) + ':' + pad2(d.getSeconds());
    }
    function now() { return Date.now(); }

    function setState(kind, msg){
      stateEl.textContent = msg || kind;
      if (kind === 'ok') {
        lampEl.style.background = '#22c55e';
        lampEl.style.boxShadow = '0 0 12px rgba(34,197,94,.45)';
      } else if (kind === 'wait') {
        lampEl.style.background = '#f59e0b';
        lampEl.style.boxShadow = '0 0 10px rgba(245,158,11,.35)';
      } else {
        lampEl.style.background = '#ef4444';
        lampEl.style.boxShadow = '0 0 10px rgba(239,68,68,.35)';
      }
    }

    function trimPayload(ev){
      // Make a friendly clone without noisy keys
      const out = {...ev};
      delete out.__raw;
      delete out.execUrlPrefix;
      // If server includes 'message' and 'msg', prefer 'msg'
      if (!out.msg && out.message) out.msg = out.message;
      return out;
    }

    function friendlyMessage(ev){
      // Prefer msg if present
      if (ev.msg) return ev.msg;

      // Type-specific fallbacks
      switch (ev.type) {
        case 'lead': {
          const p = [];
          if ('index' in ev && 'total' in ev) p.push(`index=${ev.index}, total=${ev.total}`);
          if (ev.leadName) p.push(`lead=${ev.leadName}`);
          return p.join(', ') || 'lead';
        }
        case 'numbers': {
          const p = [];
          if (ev.leadName) p.push(`lead=${ev.leadName}`);
          if ('listedCount' in ev) p.push(`listed=${ev.listedCount}`);
          if ('extraCount' in ev) p.push(`extras=${ev.extraCount}`);
          if ('flaggedCount' in ev) p.push(`flagged=${ev.flaggedCount}`);
          return p.join(', ') || 'numbers';
        }
        case 'badge': {
          if ('totalPremium' in ev) return `⭐ totalPremium=${ev.totalPremium}`;
          return 'badge';
        }
        case 'sheet': {
          if (ev.url) return ev.url;
          return 'sheet';
        }
        case 'done': {
          if ('processed' in ev) return `processed=${ev.processed}`;
          return 'done';
        }
        case 'error': {
          return ev.error || ev.message || 'error';
        }
        default:
          // As a last resort, pick a couple safe fields
          const allow = ['leadName','index','total','processed','url','href'];
          const picked = [];
          for (const k of allow) if (k in ev) picked.push(`${k}=${ev[k]}`);
          return picked.join(', ') || (ev.type || 'info');
      }
    }

    function addRow(tsMs, type, msg){
      emptyEl.style.display = 'none';
      const row = document.createElement('div');
      row.className = 'row';

      const cTime = document.createElement('div');
      cTime.className = 'cell clock';
      cTime.textContent = mmss(tsMs);

      const cType = document.createElement('div');
      cType.className = 'cell type';
      const pill = document.createElement('span');
      pill.className = `pill ${type}`;
      const dot = document.createElement('span');
      dot.className = 'dot';
      dot.style.background =
        type==='info'    ? getComputedStyle(document.documentElement).getPropertyValue('--ok') :
        type==='lead'    ? getComputedStyle(document.documentElement).getPropertyValue('--lead') :
        type==='sheet'   ? getComputedStyle(document.documentElement).getPropertyValue('--sheet') :
        type==='error'   ? getComputedStyle(document.documentElement).getPropertyValue('--err') :
        type==='done'    ? getComputedStyle(document.documentElement).getPropertyValue('--done') :
        type==='numbers' ? getComputedStyle(document.documentElement).getPropertyValue('--number') :
        type==='badge'   ? getComputedStyle(document.documentElement).getPropertyValue('--badge') :
                           getComputedStyle(document.documentElement).getPropertyValue('--pulse');
      pill.appendChild(dot);
      const label = document.createTextNode(type === 'pulse' ? '● pulse' : type);
      pill.appendChild(label);
      cType.appendChild(pill);

      const cMsg = document.createElement('div');
      cMsg.className = 'cell msg';
      cMsg.textContent = msg || '';

      rowsEl.appendChild(cTime);
      rowsEl.appendChild(cType);
      rowsEl.appendChild(cMsg);

      // Scroll to bottom
      rowsEl.parentElement.scrollTop = rowsEl.parentElement.scrollHeight;
    }

    function routeEvent(e){
      // e is an EventSource event; e.type may be '', or a named event
      const ts = now();
      let type = e.type || 'info';
      let payload = {};
      try {
        payload = e.data ? JSON.parse(e.data) : {};
      } catch { payload = {}; }

      // Normalize heartbeat -> pulse
      if (type === 'heartbeat' || payload.type === 'heartbeat') {
        type = 'pulse';
      }

      // Throttle pulse to at most once every 10s
      if (type === 'pulse') {
        if (ts - lastPulseMs < 10_000) return;
        lastPulseMs = ts;
        addRow(ts, 'pulse', '');
        return;
      }

      // Prefer payload.type if it’s one of our known types
      const known = new Set(['info','lead','sheet','error','done','numbers','badge']);
      if (payload.type && known.has(payload.type)) type = payload.type;

      const clean = trimPayload(payload);
      const msg = friendlyMessage({ type, ...clean });
      addRow(clean.ts || ts, type, msg);
    }

    function connect(){
      try { if (es) es.close(); } catch {}
      setState('wait', 'connecting…');

      es = new EventSource(ENDPOINT, { withCredentials:false });

      es.onopen = () => {
        setState('ok', 'connected to /events');
        backoff = 1000;
        addRow(now(), 'info', 'connected to /events');
      };

      // Default message
      es.onmessage = routeEvent;

      // Named events we care about
      ['info','lead','sheet','error','done','numbers','badge','heartbeat'].forEach(t => {
        es.addEventListener(t, routeEvent);
      });

      es.onerror = () => {
        setState('wait', `retry in ~${Math.round(backoff/1000)}s`);
        try { es.close(); } catch {}
        setTimeout(connect, backoff + Math.floor(Math.random()*400));
        backoff = Math.min(MAX_BACKOFF, backoff * 2);
      };
    }

    // Kick it off
    connect();

    // If tab was hidden a while and the stream closed, reconnect quickly on focus
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && es && es.readyState === EventSource.CLOSED) {
        connect();
      }
    });
  </script>
</body>
</html>
