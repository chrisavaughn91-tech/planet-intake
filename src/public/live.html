<!-- src/public/live.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Planet Lead Pull — Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0d0f14;
      --card: #151a22;
      --muted: #8b98a5;
      --text: #e7eef7;
      --accent: #7cc0ff;
      --good: #7dffa0;
      --warn: #ffd36a;
      --bad: #ff7d7d;
      --chip: #202733;
      --chip-border: #2b3544;
      --row-border: #1d2330;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 32px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: .2px;
    }
    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-left: 6px;
    }
    .chips { display: flex; gap: 6px; flex-wrap: wrap; }
    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--chip-border);
      font-size: 12px;
      color: var(--muted);
    }
    .chip.on { color: var(--text); border-color: var(--accent); }
    .controls {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 6px;
    }
    input[type="text"] {
      background: var(--card);
      border: 1px solid var(--chip-border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      min-width: 260px;
    }
    button, .btn {
      background: var(--card);
      border: 1px solid var(--chip-border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn.on { border-color: var(--accent); }
    .table {
      margin-top: 14px;
      border: 1px solid var(--chip-border);
      border-radius: 10px;
      overflow: hidden;
    }
    .thead, .row {
      display: grid;
      grid-template-columns: 92px 88px 1fr;
      gap: 0;
      border-bottom: 1px solid var(--row-border);
    }
    .thead { background: #0f141d; color: var(--muted); font-size: 12px; }
    .thead div { padding: 8px 10px; }
    .row div { padding: 10px; font-size: 13px; line-height: 1.35; }
    .lvl { text-transform: lowercase; }
    .lvl .tag {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      border: 1px solid var(--chip-border); background: var(--chip); color: var(--muted);
      font-size: 11px;
    }
    .lvl .tag.info { color: var(--text); }
    .lvl .tag.start { color: var(--accent); }
    .lvl .tag.lead { color: var(--good); }
    .lvl .tag.numbers { color: var(--accent); }
    .lvl .tag.sheet { color: var(--good); }
    .lvl .tag.error { color: var(--bad); }
    .lvl .tag.done  { color: var(--good); }
    .row a {
      color: var(--accent); text-decoration: none; border-bottom: 1px dotted var(--accent);
    }
    .muted { color: var(--muted); }
    .topline { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topline">
      <h1>Planet Lead Pull — Live</h1>
      <span class="sub">Channel:</span>
      <span id="channel" class="mono chip"></span>
      <span class="sub">Elapsed:</span>
      <span id="clock" class="mono chip on">00:00:00</span>
      <span id="sheetLink" class="chip"><span class="muted">sheet:</span> <a id="sheetHref" target="_blank" rel="noopener"></a></span>
    </div>

    <div class="controls">
      <div class="chips">
        <span class="chip" data-filter="info">info</span>
        <span class="chip" data-filter="start">start</span>
        <span class="chip" data-filter="lead">lead</span>
        <span class="chip" data-filter="numbers">numbers</span>
        <span class="chip" data-filter="badge">badge</span>
        <span class="chip" data-filter="sheet">sheet</span>
        <span class="chip" data-filter="error">error</span>
        <span class="chip" data-filter="done">done</span>
        <span class="chip" data-filter="client">client</span>
      </div>
      <input id="q" type="text" placeholder="Filter text (e.g. autorun, sheet:url)" />
      <button id="clear">Clear</button>
      <button id="copy">Copy last 200</button>
      <button id="autoscroll" class="btn on">auto-scroll</button>
    </div>

    <div class="table">
      <div class="thead">
        <div>time</div>
        <div>tag</div>
        <div>message</div>
      </div>
      <div id="rows"></div>
    </div>
  </div>

  <script>
    // --- Query params ---
    const params = new URLSearchParams(location.search);
    const channel = params.get('job') || params.get('channel') || 'global';
    document.getElementById('channel').textContent = channel;

    // --- Timer starting at 00:00:00 (since first "start" event OR connect) ---
    let t0 = null;                 // will set on first event; fallback to connect time
    let tConnect = performance.now();

    const clockEl = document.getElementById('clock');
    function fmt(ms) {
      const total = Math.max(0, Math.floor(ms / 1000));
      const h = String(Math.floor(total / 3600)).padStart(2,'0');
      const m = String(Math.floor((total % 3600) / 60)).padStart(2,'0');
      const s = String(total % 60).padStart(2,'0');
      return `${h}:${m}:${s}`;
    }
    setInterval(() => {
      const base = (t0 ?? tConnect);
      clockEl.textContent = fmt(performance.now() - base);
    }, 500);

    // --- UI state ---
    const rows = document.getElementById('rows');
    const filterChips = new Map();
    document.querySelectorAll('.chip[data-filter]').forEach(chip => {
      chip.addEventListener('click', () => {
        const key = chip.dataset.filter;
        const on = chip.classList.toggle('on');
        if (on) filterChips.set(key, true); else filterChips.delete(key);
        applyFilter();
      });
    });
    const q = document.getElementById('q');
    q.addEventListener('input', applyFilter);
    const clearBtn = document.getElementById('clear');
    clearBtn.addEventListener('click', () => { rows.innerHTML = ''; });
    const copyBtn = document.getElementById('copy');
    copyBtn.addEventListener('click', () => {
      const lines = [...rows.querySelectorAll('.row')].slice(-200)
        .map(r => r.dataset.raw || r.textContent.trim());
      navigator.clipboard.writeText(lines.join('\n')).catch(()=>{});
    });
    const autoBtn = document.getElementById('autoscroll');
    let autoScroll = true;
    autoBtn.addEventListener('click', () => {
      autoScroll = !autoScroll;
      autoBtn.classList.toggle('on', autoScroll);
    });

    function applyFilter() {
      const text = q.value.trim().toLowerCase();
      const tagFilters = [...filterChips.keys()];
      for (const row of rows.querySelectorAll('.row')) {
        const matchesTag = tagFilters.length === 0 || tagFilters.includes(row.dataset.tag);
        const matchesText = !text || (row.dataset.raw || '').toLowerCase().includes(text);
        row.style.display = (matchesTag && matchesText) ? '' : 'none';
      }
    }

    function addRow(tag, message, raw, url) {
      const now = performance.now();
      // Initialize t0 the moment we see an explicit "start" OR first event if none appear
      if (t0 === null) {
        if ((tag || '').toLowerCase() === 'start') t0 = now;
        else if (!t0) t0 = tConnect; // fallback to connect time, then will be replaced on "start"
      }
      const elapsed = fmt(now - (t0 ?? tConnect));

      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.tag = (tag || 'info').toLowerCase();
      row.dataset.raw = raw || message || '';
      row.innerHTML = `
        <div class="time mono">${elapsed}</div>
        <div class="lvl"><span class="tag ${row.dataset.tag}">${row.dataset.tag}</span></div>
        <div class="msg"></div>
      `;
      const msg = row.querySelector('.msg');
      msg.textContent = message || '';
      if (url) {
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = 'open';
        msg.appendChild(document.createTextNode(' '));
        msg.appendChild(a);
        // also surface sheet link in header if it's a sheet event
        if ((row.dataset.tag === 'sheet' || row.dataset.tag === 'numbers') && url.includes('docs.google.com/spreadsheets')) {
          const link = document.getElementById('sheetHref');
          link.textContent = url;
          link.href = url;
          document.getElementById('sheetLink').classList.add('on');
        }
      }
      rows.appendChild(row);
      applyFilter();
      if (autoScroll) row.scrollIntoView({block:'end'});
    }

    // --- SSE wiring (per-job channel) ---
    const ev = new EventSource(`/events?job=${encodeURIComponent(channel)}`);
    ev.onmessage = (e) => {
      try {
        const payload = JSON.parse(e.data || '{}');
        const tag = (payload.tag || payload.type || 'info').toString();
        const txt = payload.text || payload.msg || payload.message || payload.event || '';
        const url = payload.url || payload.href || null;
        addRow(tag, txt, e.data, url);
      } catch (_) {
        addRow('info', e.data || '', e.data, null);
      }
    };
    ev.onerror = () => {
      addRow('error', 'stream: disconnected (retrying…)');
    };

    // Announce client connected
    addRow('info', 'client: connected');
  </script>
</body>
</html>
