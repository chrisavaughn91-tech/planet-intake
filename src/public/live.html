<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Planet Lead Pull — Live</title>
  <style>
    :root{
      --bg:#0b0e11; --panel:#11161e; --fg:#e7eef8; --muted:#9fb0c3; --ok:#71d68a; --warn:#ffcc66; --err:#ff6b6b;
      --row:#0f131a; --row2:#0c1016; --accent:#67b2ff; --divider:#1b2533;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    header{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--divider);background:var(--panel);position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:16px}
    .controls{display:flex;gap:10px;align-items:center}
    input[type="text"]{background:#0c1117;border:1px solid #223048;border-radius:8px;color:var(--fg);padding:8px 10px;min-width:260px}
    button{appearance:none;border:1px solid #314158;background:#182234;color:#cfe2ff;border-radius:8px;padding:7px 10px;cursor:pointer}
    button.primary{border-color:#2a75d4;background:#2a75d4;color:#fff}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #334; background:#141b24;border-radius:999px;padding:4px 8px;font-size:12px;color:#b8c7d8}
    .row{display:grid;grid-template-columns:90px 80px 1fr;gap:10px;align-items:start;padding:10px 12px;border-bottom:1px dashed #1b2838;background:linear-gradient(180deg,var(--row),var(--row2))}
    .row .ts{color:#9ab;white-space:nowrap}
    .row .type{color:#b7c9df}
    .row .msg{white-space:pre-wrap;word-break:break-word}
    .row.lead{border-left:3px solid var(--accent); margin-top:6px}
    .indent{margin-left:8px;border-left:2px solid #203047;padding-left:10px}
    .muted{color:#8aa1b6}
    .ok {color:var(--ok)}
    .err{color:var(--err)}
    .warn{color:var(--warn)}
    .note{color:#8aa1b6}
    .pill{display:inline-block;padding:2px 6px;border-radius:999px;background:#0e1520;border:1px solid #2a3b55;color:#a9c2e0;font-size:12px}
    #log{padding-bottom:48px}
  </style>
</head>
<body>
  <header>
    <h1>Planet Lead Pull — Live</h1>
    <div class="controls">
      <input id="filter" type="text" placeholder="Filter text (e.g. autorun, sheet:url, jobId)…">
      <span class="chip"><input id="auto" type="checkbox" checked> auto-scroll</span>
      <button id="clear">Clear</button>
      <button id="copy">Copy last 200</button>
    </div>
  </header>

  <div id="meta" class="note" style="padding:10px 16px;border-bottom:1px solid #132030"></div>
  <div id="legend" class="note" style="display:none"></div>
  <div id="log" role="log" aria-live="polite"></div>

  <script>
    // --- helpers ---
    const $ = sel => document.querySelector(sel);
    const filterEl = $('#filter');
    const autoEl = $('#auto');
    const logEl = $('#log');
    const metaEl = $('#meta');

    const params = new URLSearchParams(location.search);
    const jobId  = params.get('job') || params.get('jobId') || '';

    let startAt = performance.now(); // elapsed clock 00:00:00 from page open (matches “first start event” idea)
    let lastLeadGroup = null;

    function fmt(t){
      const ms = Math.max(0, t - startAt);
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }
    function passesFilter(text){
      const f = filterEl.value.trim().toLowerCase();
      return !f || text.toLowerCase().includes(f);
    }
    function maybeScroll(){
      if (autoEl.checked) logEl.lastElementChild?.scrollIntoView({behavior:'smooth',block:'end'});
    }

    function makeRow(type, text, cls=''){
      const row = document.createElement('div');
      row.className = `row ${type} ${cls}`.trim();
      const ts = document.createElement('div');
      ts.className = 'ts';
      ts.textContent = fmt(performance.now());
      const ty = document.createElement('div');
      ty.className = 'type';
      ty.textContent = type;
      const msg = document.createElement('div');
      msg.className = 'msg';
      msg.textContent = text;
      row.append(ts,ty,msg);
      return row;
    }

    function addRow(type, text, cls=''){
      if (!passesFilter(`${type} ${text}`)) return;
      const row = makeRow(type, text, cls);
      // simple grouping: when a 'lead' appears, start a group; indent subsequent rows until next 'lead'
      if (type === 'lead') {
        lastLeadGroup = row;
        logEl.appendChild(row);
      } else if (lastLeadGroup) {
        const wrap = document.createElement('div');
        wrap.className = 'indent';
        wrap.appendChild(row);
        logEl.appendChild(wrap);
      } else {
        logEl.appendChild(row);
      }
      maybeScroll();
    }

    $('#clear').addEventListener('click', ()=>{ logEl.innerHTML=''; lastLeadGroup=null; });
    $('#copy').addEventListener('click', ()=>{
      const nodes = Array.from(logEl.children).slice(-200);
      const text = nodes.map(n => n.innerText.replace(/\n+/g,'  ')).join('\n');
      navigator.clipboard.writeText(text).catch(()=>{});
    });

    metaEl.textContent = jobId ? `Live stream for job ${jobId}` : `Live stream (no jobId provided — showing all events)`;

    // --- connect to server-sent events, filtering by jobId if provided ---
    const es = new EventSource(`/events${jobId ? `?jobId=${encodeURIComponent(jobId)}` : ''}`);

    es.addEventListener('open', ()=> addRow('info','stream: connected','ok'));
    es.addEventListener('error', ()=> addRow('error','stream: disconnected','err'));

    const handlers = {
      info:   d => addRow('info',   d.msg ?? JSON.stringify(d)),
      start:  d => addRow('start',  d.msg ?? JSON.stringify(d)),
      lead:   d => addRow('lead',   d.msg ?? (d.lead && d.lead.name) ? `lead: ${(d.lead.name||'').toUpperCase()}` : JSON.stringify(d)),
      numbers:d => addRow('numbers',d.msg ?? JSON.stringify(d)),
      badge:  d => addRow('badge',  d.msg ?? JSON.stringify(d)),
      done:   d => addRow('done',   d.msg ?? JSON.stringify(d),'ok'),
      error:  d => addRow('error',  d.msg ?? JSON.stringify(d),'err'),
      sheet:  d => {
        if (d.url) {
          // clickable link
          const row = makeRow('sheet', d.url);
          const msgEl = row.querySelector('.msg');
          msgEl.innerHTML = '';
          const a = document.createElement('a');
          a.href = d.url; a.target = '_blank'; a.rel='noopener';
          a.textContent = d.url;
          msgEl.appendChild(a);
          if (passesFilter(`sheet ${d.url}`)) logEl.appendChild(row);
          maybeScroll();
        } else {
          addRow('sheet', d.msg ?? JSON.stringify(d));
        }
      }
    };

    es.addEventListener('message', ev=>{
      try{
        const m = JSON.parse(ev.data);
        const { type, data } = m;
        if (jobId && data && data.jobId && data.jobId !== jobId) return; // extra defense
        (handlers[type] || handlers.info)(data || {});
      }catch(_){}
    });
  </script>
</body>
</html>
