<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Planet Lead Pull — Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- same UI as your current version; tiny comment added to avoid drift -->
  <style>
    :root{color-scheme:dark light}
    body{margin:0;background:#0b0f14;color:#e7eef7;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1f2a37;background:#0f1620;position:sticky;top:0}
    .title{font-weight:700}
    .controls{display:flex;gap:10px;align-items:center}
    .btn{border:1px solid #2a3a4d;background:#111a24;color:#e7eef7;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:12px}
    .rows{padding:10px 18px}
    .row{display:grid;grid-template-columns:100px 80px 1fr;gap:14px;padding:10px 0;border-bottom:1px dashed #1f2a37}
    .ts{opacity:.7}
    .type{opacity:.85}
    .msg a{color:#93c5fd}
  </style>
</head>
<body>
  <div class="bar">
    <div class="title">Planet Lead Pull — Live</div>
    <div class="controls">
      <input id="filter" class="btn" placeholder="Filter text (e.g. autorun, sheet:url, jobId)..." />
      <button id="clear" class="btn">Clear</button>
      <label class="btn"><input id="auto" type="checkbox" checked /> auto-scroll</label>
      <button id="copy" class="btn">Copy last 200</button>
    </div>
  </div>

  <div class="rows" id="rows"></div>

  <script>
    const $ = sel => document.querySelector(sel);
    const rows = $("#rows");
    const url = new URL(location.href);
    const job = url.searchParams.get("job") || "";

    const startedAt = Date.now();
    const pad = n => String(n).padStart(2, "0");
    const elapsed = () => {
      const ms = Date.now() - startedAt;
      const s = Math.floor(ms/1000);
      return `${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`;
    };

    function addRow(type, msg) {
      const f = $("#filter").value.trim().toLowerCase();
      if (f && !JSON.stringify(msg).toLowerCase().includes(f)) return;

      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="ts">${elapsed()}</div>
        <div class="type">${type}</div>
        <div class="msg"></div>
      `;
      const cell = row.querySelector(".msg");

      if (msg && msg.sheetUrl) {
        const a = document.createElement("a");
        a.href = msg.sheetUrl; a.target = "_blank"; a.rel = "noopener";
        a.textContent = msg.sheetUrl;
        cell.appendChild(document.createTextNode("sheeturl: "));
        cell.appendChild(a);
      } else if (typeof msg === "string") {
        cell.textContent = msg;
      } else {
        cell.textContent = msg && msg.msg ? msg.msg : JSON.stringify(msg || {});
      }

      rows.appendChild(row);
      if ($("#auto").checked) row.scrollIntoView({ block: "end" });
    }

    $("#filter").addEventListener("input", () => { rows.innerHTML = ""; });
    $("#clear").addEventListener("click", () => { rows.innerHTML = ""; });
    $("#copy").addEventListener("click", async () => {
      const text = [...rows.querySelectorAll(".row")].slice(-200).map(r => r.innerText).join("\n");
      try { await navigator.clipboard.writeText(text); } catch {}
    });

    const es = new EventSource(`/events?job=${encodeURIComponent(job)}`, { withCredentials: false });
    es.addEventListener("info",    e => addRow("info",    JSON.parse(e.data||"{}")));
    es.addEventListener("start",   e => addRow("start",   JSON.parse(e.data||"{}")));
    es.addEventListener("lead",    e => addRow("lead",    JSON.parse(e.data||"{}")));
    es.addEventListener("numbers", e => addRow("numbers", JSON.parse(e.data||"{}")));
    es.addEventListener("badge",   e => addRow("badge",   JSON.parse(e.data||"{}")));
    es.addEventListener("sheet",   e => addRow("sheet",   JSON.parse(e.data||"{}")));
    es.addEventListener("done",    e => addRow("done",    JSON.parse(e.data||"{}")));
    es.addEventListener("error",   e => addRow("error",   JSON.parse(e.data||"{}")));
    es.addEventListener("ping",    _ => {/* heartbeat */});
    es.onerror = () => addRow("error", { msg: "stream: disconnected" });
    es.onopen  = () => addRow("info",  { msg: "client: connected" });

    addRow("info", job ? { msg: `Live stream for job ${job}` } :
                       { msg: "Live stream (no jobId provided — showing all events)" });
  </script>
</body>
</html>
