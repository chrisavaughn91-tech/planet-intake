<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planet Intake — Live</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111926;
      --muted: #8aa0b4;
      --fg: #e7eef7;
      --accent: #86b7ff;

      --info:  #8aa0b4;   /* slate */
      --lead:  #ffd166;   /* amber */
      --sheet: #33d17a;   /* green */
      --error: #ff6b6b;   /* red */
      --done:  #cdb4ff;   /* purple */
    }
    html,body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .bar {
      display: flex; align-items: center; gap: 12px;
      background: var(--card); border-radius: 12px; padding: 10px 12px; margin-bottom: 10px;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--error); box-shadow: 0 0 0 2px #0003; }
    .dot.ok    { background: #2ecc71; }
    .dot.wait  { background: #f1c40f; }
    .bar small { color: var(--muted); }
    .legend { margin-left: auto; display: flex; gap: 10px; flex-wrap: wrap; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 2px 8px; border-radius: 999px; background: #ffffff10; color: var(--fg);
      border: 1px solid #ffffff12; font-size: 12px;
    }
    .sw { width: 10px; height: 10px; border-radius: 2px; background: var(--muted); }
    .sw.info  { background: var(--info); }
    .sw.lead  { background: var(--lead); }
    .sw.sheet { background: var(--sheet); }
    .sw.error { background: var(--error); }
    .sw.done  { background: var(--done); }

    .log {
      background: var(--card); border-radius: 12px; padding: 4px 0; overflow: auto; max-height: calc(100vh - 140px);
      border: 1px solid #ffffff0f;
    }
    .row {
      display: grid; grid-template-columns: 140px 100px 1fr; gap: 14px;
      padding: 8px 12px; border-bottom: 1px solid #ffffff08;
    }
    .row:last-child { border-bottom: none; }
    .ts { color: var(--muted); font-variant-numeric: tabular-nums; }
    .ev { color: var(--muted); }

    /* colorize by type */
    .row.info  .ev { color: var(--info); }
    .row.lead  .ev { color: var(--lead); }
    .row.sheet .ev { color: var(--sheet); }
    .row.error .ev { color: var(--error); }
    .row.done  .ev { color: var(--done); }

    .msg code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #00000030; padding: 0 4px; border-radius: 4px;
    }

    /* START:COMPACT-MSG-CSS */
    .col-msg {
      max-width: calc(100% - 280px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* END:COMPACT-MSG-CSS */

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div id="dot" class="dot"></div>
      <div id="status">Connecting…</div>
      <small id="attempt"></small>
      <div class="legend" aria-label="Legend">
        <span class="pill"><span class="sw info"></span>info</span>
        <span class="pill"><span class="sw lead"></span>lead</span>
        <span class="pill"><span class="sw sheet"></span>sheet</span>
        <span class="pill"><span class="sw error"></span>error</span>
        <span class="pill"><span class="sw done"></span>done</span>
      </div>
    </div>
    <div id="log" class="log" role="log" aria-live="polite"></div>
  </div>

  <script>
    // ========= util =========
    const logEl = document.getElementById('log');
    const dot = document.getElementById('dot');
    const statusEl = document.getElementById('status');
    const attemptEl = document.getElementById('attempt');

    const fmtTime = (d=new Date()) =>
      d.toLocaleTimeString([], { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });

    // ---- compact message rendering helpers ----
    function tryParseJSON(s) {
      try { return JSON.parse(s); } catch { return { msg: String(s ?? '') }; }
    }
    const nf = new Intl.NumberFormat();
    const fmt = (n) => (typeof n === 'number' ? nf.format(n) : n);

    // Turn the event payload into a short, readable sentence
    function formatEventText(obj) {
      if (!obj || typeof obj !== 'object') return String(obj ?? '');
      if (obj.msg) return obj.msg;                                 // prefer explicit message
      if (obj.type === 'numbers') {                                // summarize the counters
        const parts = [];
        if (obj.index != null && obj.total != null) parts.push(`lead ${obj.index}/${obj.total}`);
        if (obj.monthly != null) parts.push(`monthly=${fmt(obj.monthly)}`);
        if (obj.listedCount != null) parts.push(`listed=${fmt(obj.listedCount)}`);
        if (obj.extraCount != null) parts.push(`extras=${fmt(obj.extraCount)}`);
        if (obj.flaggedCount != null) parts.push(`flagged=${fmt(obj.flaggedCount)}`);
        return parts.join(' · ') || 'numbers';
      }
      if (obj.type === 'badge' && obj.badge) {
        const extra = obj.totalPremium != null ? ` • totalPremium:${fmt(obj.totalPremium)}` : '';
        return `badge: ${obj.badge}${extra}`;
      }
      if (obj.type === 'sheet' && obj.url) return obj.url;
      if (obj.href) return obj.href;
      if (obj.error) return obj.error.message || String(obj.error);
      // last resort: short JSON
      try { return JSON.stringify(obj); } catch { return String(obj); }
    }

    function appendRow(type, obj) {
      const row = document.createElement('div');
      row.className = 'row ' + (type || 'info');

      const ts = document.createElement('div');
      ts.className = 'ts';
      ts.textContent = fmtTime();

      const ev = document.createElement('div');
      ev.className = 'ev';
      ev.textContent = type || 'info';

      const msg = document.createElement('div');
      msg.className = 'msg col-msg';
      // START:COMPACT-MSG-ASSIGN
      msg.textContent = formatEventText(obj);
      msg.title = obj.__raw || '';   // hover to see full raw payload
      // END:COMPACT-MSG-ASSIGN

      row.append(ts, ev, msg);
      logEl.appendChild(row);
      // keep view pinned to bottom if user is near bottom
      if (Math.abs(logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight) < 80) {
        logEl.scrollTop = logEl.scrollHeight;
      }
    }

    // ========= SSE with auto-reconnect =========
    const ENDPOINT = (window.__EVENTS_URL__ || '/events');

    let es = null;
    let backoff = 1000;         // 1s -> 2s -> 4s -> … -> 10s
    const MAX_BACKOFF = 10000;

    function setState(kind, detail='') {
      dot.classList.remove('ok','wait');
      if (kind === 'ok') dot.classList.add('ok');
      if (kind === 'wait') dot.classList.add('wait');
      statusEl.textContent = (kind === 'ok') ? 'Connected' : (kind === 'wait') ? 'Reconnecting…' : 'Disconnected';
      attemptEl.textContent = detail;
    }

    // START:ROUTE-EVENT-COMPACT
    function routeEvent(e) {
      const kind = (e.type && e.type !== 'message') ? e.type : 'info';
      const obj = (typeof e.data === 'string') ? tryParseJSON(e.data) : (e.data || {});
      obj.__raw = typeof e.data === 'string' ? e.data : JSON.stringify(e.data || {});
      obj.type = obj.type || kind;
      appendRow(kind, obj);
    }
    // END:ROUTE-EVENT-COMPACT

    function connect() {
      if (es) try { es.close(); } catch {}
      es = new EventSource(ENDPOINT, { withCredentials: false });

      es.onopen = () => {
        setState('ok');
        backoff = 1000; // reset backoff on healthy connect
        appendRow('info', { message: 'connected to ' + ENDPOINT });
      };

      // default messages
      es.onmessage = (e) => routeEvent(e);

      // named event handlers we care about (no-ops if server doesn’t emit them)
      ['info','lead','sheet','error','done'].forEach((t) => {
        es.addEventListener(t, routeEvent);
      });

      es.onerror = () => {
        setState('wait', `retry in ${Math.round(backoff/1000)}s`);
        appendRow('error', { message: 'event stream error; reconnecting…' });
        try { es.close(); } catch {}
        setTimeout(connect, backoff + Math.floor(Math.random()*400)); // jitter
        backoff = Math.min(MAX_BACKOFF, backoff * 2);
      };
    }

    // kick it off
    connect();

    // Optional: when tab is hidden for a long period and the connection drops,
    // try a quick reconnect on visibilitychange.
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && es && es.readyState === EventSource.CLOSED) {
        connect();
      }
    });
  </script>
</body>
</html>
