<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Planet Lead Pull — Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- External theme variables (kept) -->
  <link rel="stylesheet" href="/live-themes.css" />

  <!-- Base + minimal page styles (colors come from CSS variables) -->
  <style>
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    header { position:sticky; top:0; z-index:10; background:var(--header-bg);
      backdrop-filter: blur(6px); border-bottom:1px solid var(--border); padding:10px 12px; }
    .brand { font-weight:700; letter-spacing:.3px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
    .chip { display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border-radius:999px;
      background:var(--pill); border:1px solid var(--pill-b); font-size:12px; cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease, opacity .15s ease; }
    .chip[data-on="false"] { opacity:.35; }
    .button { padding:4px 10px; border-radius:8px; border:1px solid var(--pill-b); background:var(--pill); cursor:pointer;
      transition: border-color .15s ease, box-shadow .15s ease; }
    .button:hover { border-color:var(--hover-border); box-shadow:var(--hover-shadow); }
    .input { padding:5px 9px; border-radius:8px; border:1px solid var(--pill-b); background:var(--input-bg); color:var(--fg); min-width:240px; }
    .legend { margin-top:6px; font-size:12px; color:var(--muted); }

    .banner { position:sticky; top:64px; background:var(--reconnect-bg); color:var(--reconnect-fg);
      border-bottom:1px solid var(--reconnect-border); padding:6px 12px; display:none; }

    .container { padding:12px 12px 20px; }
    .row { display:grid; grid-template-columns:100px 140px 1fr; gap:10px; align-items:start;
      padding:7px 0; border-bottom:1px dashed var(--row-divider); animation: fadeIn .15s ease forwards; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    .time { color:var(--time-fg); font-variant-numeric:tabular-nums; }
    .type { display:inline-flex; align-items:center; gap:6px }
    .level { font-weight:600 }
    .level-info{color:var(--accent-info)} .level-start{color:var(--accent-start)}
    .level-lead{color:var(--accent-lead)} .level-numbers{color:var(--accent-numbers)}
    .level-badge{color:var(--accent-badge)} .level-sheet{color:var(--accent-sheet)}
    .level-error{color:var(--accent-error)} .level-done{color:var(--accent-done)} .level-client{color:var(--accent-client)}

    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:var(--pill);
      border:1px solid var(--pill-b); font-size:12px; color:var(--pill-fg); margin-left:6px; }

    .msg { white-space:pre-wrap; color:var(--msg-fg); }
    .sub { color:var(--muted) }

    /* newest row emphasis for neon */
    #log .row:last-child { box-shadow: var(--newest-shadow); border-bottom-color: var(--newest-divider); }

    .right { margin-left:auto; display:flex; gap:8px; align-items:center }
    .stickyNew { position:sticky; bottom:12px; display:none; justify-content:center; }
    .stickyNew .button { background:var(--sticky-btn-bg); border-color:var(--sticky-btn-bd); }
  </style>
</head>
<body data-theme="neon"><!-- hard-lock Neon -->
  <header>
    <div class="brand">Planet Lead Pull — Live</div>
    <div class="toolbar" id="toolbar">
      <!-- (Key removed) Keep only text filter, auto-scroll toggle, clear/copy -->
      <input id="q" class="input" placeholder="Filter text (e.g. autorun, sheet:url, jobId)" />
      <label class="chip" id="autoScroll" data-on="true" title="Auto-scroll on new messages">auto-scroll</label>
      <button id="clearBtn" class="button" title="Clear log view">Clear</button>
      <button id="copyBtn" class="button" title="Copy last 200 lines">Copy last 200</button>
    </div>
    <div class="legend">
      Timestamps show elapsed time since run start (first <span class="level-start">start</span> event).
    </div>
  </header>

  <div class="banner" id="banner">Reconnecting…</div>
  <div class="container" id="log"></div>
  <div class="stickyNew" id="stickyNew"><button class="button" onclick="scrollToEnd(true)">New messages ↓</button></div>

  <script>
    // Elements
    const logEl = document.getElementById('log');
    const banner = document.getElementById('banner');
    const inputQ = document.getElementById('q');
    const autoScrollChip = document.getElementById('autoScroll');
    const stickyNew = document.getElementById('stickyNew');

    // Auto-scroll default ON; single toggle
    autoScrollChip.addEventListener('click', ()=>{
      autoScrollChip.dataset.on = autoScrollChip.dataset.on === 'true' ? 'false' : 'true';
      maybeShowNew();
    });

    // Clear / Copy
    document.getElementById('clearBtn').onclick = ()=>{ logEl.innerHTML = ''; };
    document.getElementById('copyBtn').onclick = ()=>{
      const rows = [...logEl.querySelectorAll('.row')].slice(-200);
      const text = rows.map(r => r.innerText.replace(/\s+\n/g,' ')).join('\n');
      navigator.clipboard.writeText(text).catch(()=>{});
    };

    // Filtering
    inputQ.addEventListener('input', ()=> refilter());
    function refilter(){
      const q = inputQ.value.trim().toLowerCase();
      [...logEl.children].forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = (!q || text.includes(q)) ? '' : 'none';
      });
    }

    // Timing (elapsed from first 'start')
    let t0 = null;
    const now = () => performance.now();
    const fmtHMS = (ms) => {
      const s = Math.max(0, Math.floor(ms/1000));
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
      const pad = (n)=> String(n).padStart(2,'0');
      return `${pad(h)}:${pad(m)}:${pad(ss)}`;
    };
    const elapsed = () => !t0 ? '00:00:00' : fmtHMS(now() - t0);

    // Row rendering helpers
    function scrollToEnd(force=false){
      logEl.scrollTop = logEl.scrollHeight;
      if (force) stickyNew.style.display = 'none';
    }
    function maybeShowNew(){
      const atBottom = Math.abs(logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight) < 4;
      stickyNew.style.display = (autoScrollChip.dataset.on === 'false' && !atBottom) ? 'flex' : 'none';
    }
    logEl.addEventListener('scroll', ()=> maybeShowNew());

    function addRow(levelText, msgNode){
      const row = document.createElement('div'); row.className = 'row';
      const t = document.createElement('div');  t.className = 'time'; t.textContent = elapsed();
      const ty = document.createElement('div'); ty.className = 'type';
      const lvl = document.createElement('span'); lvl.className = `level level-${levelText}`; lvl.textContent = levelText;
      ty.append(lvl);
      const m = document.createElement('div'); m.className = 'msg';
      if (msgNode instanceof Node) { m.appendChild(msgNode); } else { m.textContent = String(msgNode ?? ''); }
      row.append(t, ty, m);
      logEl.appendChild(row);

      if (autoScrollChip.dataset.on === 'true') {
        row.scrollIntoView({behavior:'smooth', block:'end'});
        stickyNew.style.display = 'none';
      } else {
        maybeShowNew();
      }
      return row;
    }

    // Lead aggregation
    let currentLead = null;  // {row, parts:{lead, numbers, badge}, index, total}
    function startLead(d){
      finalizeLead(); // close any prior
      const leadLabel = (d.index && d.total && d.leadName)
        ? `#${d.index}/${d.total} ${d.leadName}`
        : (d.msg || 'lead: opening');
      const row = addRow('lead', leadLabel);
      currentLead = { row, parts:{lead:leadLabel, numbers:null, badge:null}, index:d.index||null, total:d.total||null };
      updateLeadRow();
    }
    function updateNumbers(d){
      if (!currentLead) { addRow('numbers', `listed=${d.listedCount} extras=${d.extraCount} flagged=${d.flaggedCount}`); return; }
      currentLead.parts.numbers = `listed=${d.listedCount} extras=${d.extraCount} flagged=${d.flaggedCount}`;
      updateLeadRow();
    }
    function updateBadge(d){
      if (!currentLead) { addRow('badge', `${d.badge || ''} total=${d.totalPremium}`); return; }
      const star = d.badge ? `${d.badge} ` : '';
      currentLead.parts.badge = `${star}total=${d.totalPremium}`;
      updateLeadRow();
    }
    function finalizeLead(){
      currentLead = null;
    }
    function updateLeadRow(){
      if (!currentLead) return;
      const { row, parts } = currentLead;
      const msg = document.createElement('div');
      const main = document.createElement('div'); main.textContent = parts.lead; msg.appendChild(main);

      const details = [];
      if (parts.numbers) details.push(parts.numbers);
      if (parts.badge)   details.push(parts.badge);

      if (details.length){
        const sub = document.createElement('div'); sub.className = 'sub'; sub.textContent = details.join(' · ');
        msg.appendChild(sub);
      }
      row.querySelector('.msg').replaceChildren(msg);
    }

    // Banner helper
    function showBanner(on){ banner.style.display = on ? 'block' : 'none'; }

    // SSE hookup
    const es = new EventSource('/events');
    es.addEventListener('open', () => { showBanner(false); addRow('info', 'stream: connected'); });
    es.addEventListener('error', () => { showBanner(true); addRow('error', 'stream: error (trying to reconnect…)'); });

    // Event handlers
    const handlers = {
      info:  (d)=> addRow('info', d.msg || ''),
      start: (d)=> { if (!t0) t0 = now(); addRow('start', `max=${d.maxLeads ?? ''}`); },
      lead:  (d)=> startLead(d),
      numbers:(d)=> updateNumbers(d),
      badge: (d)=> updateBadge(d),
      sheet: (d)=> {
        // Clickable link
        const url = d.url || d.msg || '';
        const a = document.createElement('a'); a.href = url; a.textContent = url; a.target = '_blank'; a.rel = 'noopener noreferrer';
        addRow('sheet', a);
      },
      error: (d)=> addRow('error', d.msg || ''),
      done:  (d)=> { finalizeLead(); addRow('done', `processed=${d.processed} in ${d.ms}ms`); },
      client:(d)=> addRow('client', d.msg || '')
    };

    // Subscribe to all event types
    ['info','start','lead','numbers','badge','sheet','error','done','client'].forEach(type=>{
      es.addEventListener(type, (e)=>{
        try{
          const data = JSON.parse(e.data || '{}');
          if (!t0 && type === 'start') t0 = now();
          (handlers[type] || handlers.info)(data);
        }catch(err){
          addRow('error', 'parse error');
          console.error(err, e.data);
        }
      });
    });
  </script>
</body>
</html>
