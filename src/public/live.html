<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planet Lead Pull — Live</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #111827;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --text-weak: #cbd5e1;
      --accent: #60a5fa;
      --good: #34d399;
      --warn: #f59e0b;
      --bad: #f87171;
      --chip: #1f2937;
      --chipOn: #111827;
      --chipText: #cbd5e1;
      --chipOnText: #f9fafb;
      --chipRing: rgba(96,165,250,0.35);
    }
    html,body {margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    a { color: var(--accent); text-decoration: none; }
    .wrap { max-width: 1200px; margin: 28px auto; padding: 0 18px; }
    header { display:flex; align-items:center; gap:14px; margin-bottom: 12px; }
    h1 { font-size: 18px; font-weight: 700; margin:0; }
    .toolbar { display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .chips { display:flex; gap:8px; flex-wrap: wrap; }
    .chip {
      background: var(--chip);
      color: var(--chipText);
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      cursor: pointer;
      user-select: none;
    }
    .chip.on { background: var(--chipOn); color: var(--chipOnText); box-shadow: 0 0 0 2px var(--chipRing); }
    .chip:focus-visible { outline: 2px solid var(--accent); outline-offset:2px; }
    .actions { display:flex; gap:8px; }
    button, .btn {
      background: #1f2937;
      color: var(--text);
      border: 1px solid #374151;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover, .btn:hover { background:#111827; }
    .muted { color: var(--muted); }
    .row { display:grid; grid-template-columns: 120px 120px 1fr; gap:12px; align-items: start; padding: 10px 12px; border-bottom:1px solid #0f172a; }
    .row:nth-child(odd){ background: #0b1220; }
    .tag { font-weight:600; color:#cbd5e1 }
    .msg { white-space: pre-wrap; word-break: break-word; }
    .time { color:#94a3b8 }
    .filters { display:flex; gap:10px; flex-wrap: wrap; }
    .filter-input {
      background:#0b1220; border:1px solid #1e293b; color: var(--text);
      border-radius: 8px; padding:8px 10px; width: 360px;
    }
    .pill {
      font-size:12px; padding:3px 8px; border-radius:20px; background:#0b1220; border:1px solid #1e293b; color:#cbd5e1
    }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .table { border:1px solid #0f172a; border-radius:12px; overflow:hidden; }
    .empty { color:#94a3b8; padding:30px; text-align:center; border:1px dashed #1e293b; border-radius: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Planet Lead Pull — Live</h1>
      <div class="toolbar">
        <div class="chips" id="chips">
          <div class="chip on" data-tag="info">info</div>
          <div class="chip" data-tag="start">start</div>
          <div class="chip" data-tag="lead">lead</div>
          <div class="chip" data-tag="numbers">numbers</div>
          <div class="chip" data-tag="badge">badge</div>
          <div class="chip" data-tag="sheet">sheet</div>
          <div class="chip" data-tag="error">error</div>
          <div class="chip" data-tag="done">done</div>
          <div class="chip" data-tag="client">client</div>
        </div>
        <div class="filters">
          <input id="filter" class="filter-input" placeholder="Filter text (e.g. autorun, sheet:url)" />
          <button id="clear">Clear</button>
          <button id="copy">Copy last 200</button>
          <button id="autoscroll">auto-scroll</button>
        </div>
      </div>
    </header>

    <div class="muted" id="meta"></div>

    <div class="table" id="table">
      <div class="row">
        <div class="time">00:00:00</div>
        <div class="tag">info</div>
        <div class="msg">client: connected</div>
      </div>
    </div>

    <p class="muted" id="empty" style="display:none; margin-top:12px;">No events yet…</p>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const token = params.get('token') || 'dev';
    // Accept either ?channel=<id> or ?job=<id> (back-compat). Prefer channel if present.
    const channel = params.get('channel') || params.get('job') || 'global';

    const $chips = document.getElementById('chips');
    const $table = document.getElementById('table');
    const $filter = document.getElementById('filter');
    const $clear = document.getElementById('clear');
    const $copy = document.getElementById('copy');
    const $auto = document.getElementById('autoscroll');
    const $meta = document.getElementById('meta');
    const $empty = document.getElementById('empty');

    let autoscroll = false;
    let enabled = new Set(['info','start','lead','numbers','badge','sheet','error','done','client']);
    let startEpoch = Date.now();

    // Show meta for the session/channel
    $meta.innerHTML = `Channel: <span class="pill"> ${channel} </span> &nbsp; Elapsed: <span class="pill" id="elapsed">00:00:00</span> &nbsp; <span class="pill">sheet:</span>`;

    // ---- SSE binding (FIXED: jobId, not job) ----
    // NOTE: server expects ?jobId=..., we pass channel value as jobId
    const es = new EventSource(`/events?jobId=${encodeURIComponent(channel)}&token=${encodeURIComponent(token)}`);

    es.addEventListener('open', () => {
      push('info', { msg: 'client: subscribed', clientId: 1, jobid: null });
      push('info', { msg: 'client: connected', clientId: 1, jobid: null });
    });

    es.addEventListener('error', (e) => {
      push('error', { msg: 'connection lost (retrying)…' });
    });

    // generic handler: server sends "event: <type>\ndata: <json>\n\n"
    const types = ['info','start','lead','numbers','badge','sheet','error','done','client'];
    for (const t of types) {
      es.addEventListener(t, (ev) => {
        try {
          const data = JSON.parse(ev.data || '{}');
          push(t, data);
        } catch (err) {
          push('error', { msg: `bad event (${t}): ${err}` });
        }
      });
    }

    function hhmmss(ms) {
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600).toString().padStart(2,'0');
      const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
      const sec = (s%60).toString().padStart(2,'0');
      return `${h}:${m}:${sec}`;
    }

    setInterval(() => {
      const $el = document.getElementById('elapsed');
      if ($el) $el.textContent = hhmmss(Date.now() - startEpoch);
    }, 1000);

    function push(tag, data) {
      // filter by chips + text
      const txt = (typeof data === 'string' ? data : JSON.stringify(data));
      const needle = ($filter.value || '').trim().toLowerCase();
      const tagOn = enabled.has(tag);
      const textOn = !needle || txt.toLowerCase().includes(needle);

      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.tag = tag;
      if (!(tagOn && textOn)) row.style.display = 'none';

      const t = document.createElement('div');
      t.className = 'time';
      t.textContent = hhmmss(Date.now() - startEpoch);

      const tg = document.createElement('div');
      tg.className = 'tag';
      tg.textContent = tag;

      const msg = document.createElement('div');
      msg.className = 'msg';
      msg.textContent = typeof data === 'string' ? data : (data.msg ? data.msg : JSON.stringify(data));

      row.appendChild(t); row.appendChild(tg); row.appendChild(msg);
      $table.appendChild(row);

      $empty.style.display = 'none';
      if (autoscroll) row.scrollIntoView({behavior:'smooth', block:'end'});
    }

    // chip toggles
    $chips.addEventListener('click', (e) => {
      const el = e.target.closest('.chip');
      if (!el) return;
      const tag = el.dataset.tag;
      if (!tag) return;
      if (enabled.has(tag)) { enabled.delete(tag); el.classList.remove('on'); }
      else { enabled.add(tag); el.classList.add('on'); }
      refreshFilter();
    });

    $filter.addEventListener('input', refreshFilter);
    $clear.addEventListener('click', () => {
      const rows = [...$table.querySelectorAll('.row')];
      rows.slice(1).forEach(r => r.remove());
      startEpoch = Date.now();
      $empty.style.display = 'block';
    });
    $copy.addEventListener('click', async () => {
      const rows = [...$table.querySelectorAll('.row')].slice(-200);
      const text = rows.map(r => {
        const [t, tg, m] = r.children;
        return `${t.textContent}\t${tg.textContent}\t${m.textContent}`;
      }).join('\n');
      await navigator.clipboard.writeText(text);
      push('client', { msg: 'copied last 200 rows to clipboard' });
    });
    $auto.addEventListener('click', () => { autoscroll = !autoscroll; $auto.classList.toggle('on', autoscroll); });

    function refreshFilter() {
      const needle = ($filter.value || '').trim().toLowerCase();
      const rows = [...$table.querySelectorAll('.row')];
      rows.forEach((r,i) => {
        if (i === 0) return;
        const tag = r.dataset.tag || '';
        const msg = r.children[2]?.textContent?.toLowerCase() || '';
        const on = enabled.has(tag) && (!needle || msg.includes(needle));
        r.style.display = on ? '' : 'none';
      });
    }

    // Show the stream URL for easy copy if you want to inspect raw events in a new tab
    const raw = location.origin + `/events?jobId=${encodeURIComponent(channel)}&token=${encodeURIComponent(token)}`;
    const p = document.createElement('p');
    p.className = 'muted';
    p.innerHTML = `sheet: <span id="sheet-link"></span> &nbsp;&nbsp; • &nbsp;&nbsp; <a href="${raw}" target="_blank" rel="noreferrer">raw events</a>`;
    document.querySelector('.wrap').appendChild(p);

    // When a sheet event arrives, render a link
    es.addEventListener('sheet', (ev) => {
      try {
        const data = JSON.parse(ev.data || '{}');
        if (data && data.url) {
          const a = document.createElement('a');
          a.href = data.url;
          a.textContent = data.url;
          a.target = '_blank';
          a.rel = 'noreferrer';
          const slot = document.getElementById('sheet-link');
          slot.innerHTML = '';
          slot.appendChild(a);
        }
      } catch {}
    });
  </script>
</body>
</html>
