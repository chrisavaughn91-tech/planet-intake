<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Planet Lead Pull — Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg0:#0b0f13; --bg1:#0e141a; --panel:#0d1319;
      --text:#e9eef2; --muted:#9aa7b3; --soft:#1b2430;
      --accent:#6aa8ff; --good:#7dffaa; --warn:#ffd27a; --err:#ff7b7b; --info:#86b7ff;
      --lead:#c3f77a; --badge:#f6b4ff; --done:#8ef0c9; --sheet:#9ff2ff;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial;
      --radius: 12px;
    }

    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0; padding:0; background:var(--bg0); color:var(--text); font-family:var(--sans); }

    /* Soft ops-room glow */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:
        radial-gradient(900px 600px at 85% 90%, rgba(134,183,255,.05), transparent 60%),
        radial-gradient(1200px 700px at 15% 10%, rgba(143,255,160,.04), transparent 60%);
    }

    header{
      position:sticky; top:0; z-index:20;
      background:rgba(12,18,24,.92); backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:10px 12px;
    }
    .top{ display:flex; align-items:center; gap:12px; }
    .brand{ font-weight:800; letter-spacing:.5px; }
    .ops{ font-family:var(--mono); font-size:12px; color:var(--muted); }
    .spacer{ flex:1 }
    .kpi{ font-family:var(--mono); font-size:12px; color:var(--muted); display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .kpi b{ color:var(--text) }
    .sep{ opacity:.35 }
    .link{ display:flex; align-items:center; gap:6px; margin-left:8px; }
    .dot{ width:9px; height:9px; border-radius:50%; background:#1f3b2b; box-shadow:0 0 0 2px #182a21 inset; }
    .dot.ok{ background:var(--good); box-shadow:0 0 8px rgba(125,255,170,.7), 0 0 0 2px #1d2e25 inset; animation: dotPulse 1.6s ease-in-out infinite }
    @keyframes dotPulse{ 0%,100%{ transform:scale(1); opacity:.9 } 50%{ transform:scale(1.25); opacity:1 } }

    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center }
    .input{
      padding:8px 10px; border-radius:8px; border:1px solid #1e2833; background:#0f161d; color:var(--text); min-width:260px;
      font-family:var(--mono);
    }
    .button{ padding:6px 12px; border-radius:8px; border:1px solid #1e2833; background:#0f161d; color:var(--text); cursor:pointer; }
    .button:hover{ border-color:#2a3b4d }

    .wrap{ padding:12px 12px 22px }
    .panel{
      /* No outside border/shadow */
      border:none; border-radius:var(--radius);
      background:linear-gradient(180deg, var(--panel), var(--bg1));
      padding:8px 12px;
    }

    .container{}
    .row{
      display:grid; grid-template-columns:110px 120px 1fr; gap:10px; align-items:start;
      padding:8px 0;
      border-bottom:none;
      position:relative;
    }

    /* Gentle grouping for the currently active lead and its trailing rows */
    .row.in-lead { background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.015)); }
    .row.lead-start{ background:linear-gradient(180deg, rgba(106,168,255,.04), rgba(106,168,255,.02)); border-top:1px solid rgba(255,255,255,.05); }

    .time{ color:#b9c5d1; font-variant-numeric:tabular-nums; font-family:var(--mono); font-size:12px }
    .type{ font-family:var(--mono); text-transform:uppercase; color:#9fb0c1; letter-spacing:.02em }
    .type.LEAD{ color:var(--lead) } .type.BADGE{ color:var(--badge) }
    .type.NUMBERS{ color:var(--info) } .type.DONE{ color:var(--done); font-weight:700 }
    .type.SHEET{ color:var(--sheet) } .type.ERROR{ color:var(--err); font-weight:700 }
    .msg{ white-space:pre-wrap; color:#e9eef2 }

    /* Sheen underline ONLY under the last row */
    .row.last::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:2px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
      animation:sheen 1.35s ease-in-out infinite;
    }
    @keyframes sheen{
      0%,100%{ opacity:.25; filter:blur(.25px) }
      50%{ opacity:.9; filter:blur(0) }
    }

    .stickyNew{ position:sticky; bottom:12px; display:none; justify-content:center }
    .stickyNew .button{ background:#122845; border-color:#204a86 }

    .muted{ color:#9aa7b3 }

    a.linky{ color:var(--sheet); text-underline-offset:2px }
    a.linky:hover{ text-decoration:none; filter:brightness(1.1) }
  </style>
</head>
<body>
  <header>
    <div class="top">
      <div class="brand">OP: PLANET LEAD PULL</div>
      <div class="ops">Live Feed</div>
      <div class="spacer"></div>

      <div class="kpi">
        <span id="badgeCounts">Badges: ⭐ 0 (0%)  ⚪ 0 (0%)</span>
        <span class="sep">|</span>
        <span>Premium total: <b id="badgeTotal">$0.00</b></span>
        <span class="link"><span id="connDot" class="dot" aria-hidden="true"></span><span id="connText">Link</span></span>
      </div>
    </div>

    <div class="toolbar" id="toolbar">
      <input id="q" class="input" placeholder="Filter text (e.g. jobId, sheet:url)" />
      <label id="autoScroll" class="button" title="Auto-scroll on new messages" data-on="true">AUTO-SCROLL</label>
      <button id="clearBtn" class="button" title="Clear log view">Clear</button>
      <!-- Theme toggle removed per request -->
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="container" id="log"></div>
      <div class="stickyNew" id="stickyNew"><button class="button" onclick="scrollToEnd(true)">New messages ↓</button></div>
    </div>
  </div>

  <script>
    // UI refs
    const logEl = document.getElementById('log');
    const inputQ = document.getElementById('q');
    const autoScrollBtn = document.getElementById('autoScroll');
    const clearBtn = document.getElementById('clearBtn');
    const stickyNew = document.getElementById('stickyNew');
    const badgeTotalEl = document.getElementById('badgeTotal');
    const badgeCountsEl = document.getElementById('badgeCounts');
    const connDot = document.getElementById('connDot');
    const connText = document.getElementById('connText');

    // helpers
    const params = new URLSearchParams(location.search);
    const jobId = params.get('job') || null;

    // elapsed baseline
    let t0 = null;
    const now = () => performance.now();
    const pad = n => String(n).padStart(2,'0');
    function fmtHMS(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
      return `${pad(h)}:${pad(m)}:${pad(ss)}`;
    }
    function elapsed(){ return t0 ? fmtHMS(now() - t0) : '00:00:00'; }

    // runtime state
    let lastRow = null;
    let inLeadGroup = false;

    const badgeTally = { star:0, circle:0, other:0 };
    function updateBadgeKpi(){
      const denom = badgeTally.star + badgeTally.circle + badgeTally.other;
      const pct = (n) => denom ? Math.round(n/denom*100) : 0;
      const starPct = pct(badgeTally.star);
      const circlePct = pct(badgeTally.circle);
      badgeCountsEl.textContent = `Badges: ⭐ ${badgeTally.star} (${starPct}%)  ⚪ ${badgeTally.circle} (${circlePct}%)`;
    }

    function setLastRow(row){
      if (lastRow) lastRow.classList.remove('last');
      lastRow = row;
      if (lastRow) lastRow.classList.add('last');
    }

    function addRow(level, msg, meta = {}){
      // filter text
      const q = inputQ.value.trim().toLowerCase();
      const hay = `${level} ${JSON.stringify(meta)} ${msg}`.toLowerCase();
      if (q && !hay.includes(q)) return;

      // grouping rules: start a lead group at LEAD; continue group until next LEAD
      const row = document.createElement('div');
      row.className = 'row';
      if (level === 'LEAD'){
        row.classList.add('lead-start');
        inLeadGroup = true;
      } else if (inLeadGroup) {
        row.classList.add('in-lead');
      }

      // timestamp
      const t = document.createElement('div');
      t.className = 'time'; t.textContent = elapsed();

      // type
      const ty = document.createElement('div');
      ty.className = `type ${level}`; ty.textContent = level;

      // message
      const m = document.createElement('div');
      m.className = 'msg'; m.textContent = msg;

      // special formatting for sheet links
      if (level === 'SHEET'){
        const url = (meta.url || msg || '').trim();
        if (/^https?:\/\//i.test(url)){
          m.innerHTML = `sheet: <a class="linky" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
          const a = m.querySelector('a'); a.href = url;
        }
      }

      // special formatting for DONE “N leads processed in Xm Ys”
      if (level === 'DONE' && typeof meta.processed === 'number' && typeof meta.ms === 'number'){
        const totalMs = meta.ms|0;
        const minutes = Math.floor(totalMs/60000), seconds = Math.round((totalMs%60000)/1000);
        const s = `${meta.processed} ${meta.processed===1?'lead':'leads'} processed in ${minutes}m ${seconds}s`;
        m.textContent = s;
        inLeadGroup=false;
      }

      row.append(t, ty, m);
      logEl.appendChild(row);

      setLastRow(row);

      if (autoScrollBtn.dataset.on === 'true'){ row.scrollIntoView({behavior:'smooth', block:'end'}); stickyNew.style.display='none'; }
      else { maybeShowNew(); }
    }

    function maybeShowNew(){
      const atBottom = Math.abs(logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight) < 4;
      stickyNew.style.display = (autoScrollBtn.dataset.on === 'false' && !atBottom) ? 'flex' : 'none';
    }
    function scrollToEnd(force=false){ logEl.scrollTop = logEl.scrollHeight; if (force) stickyNew.style.display='none'; }
    logEl.addEventListener('scroll', ()=> maybeShowNew());

    autoScrollBtn.addEventListener('click', ()=>{
      autoScrollBtn.dataset.on = autoScrollBtn.dataset.on === 'true' ? 'false' : 'true';
      maybeShowNew();
    });
    clearBtn.addEventListener('click', ()=> { logEl.innerHTML = ''; lastRow=null; });
    inputQ.addEventListener('input', ()=> { /* append-only filtering; no rebuild */ });

    // SSE stream
    const es = new EventSource(jobId ? `/events?jobId=${encodeURIComponent(jobId)}` : '/events');

    es.addEventListener('open', ()=>{
      connDot.classList.add('ok');
      addRow('INFO', `stream: connected${jobId ? ` (job ${jobId})` : ''}`);
    });

    es.addEventListener('error', ()=>{
      connDot.classList.remove('ok');
      addRow('ERROR', 'stream: error (trying to reconnect…)');
    });

    // event handlers
    const handlers = {
      info: (d)=> addRow('INFO', d.msg || ''),
      start:(d)=>{ if (!t0) t0 = now(); inLeadGroup=false; addRow('START', `max=${d.maxLeads ?? ''}`, d); },
      lead: (d)=>{
        // desired lead format: NAME (n of total)
        const name = d.leadName || '';
        const n = (d.index||0); const total = (d.total||0);
        const msg = name ? `${name} (${n} of ${total})` : (d.msg || '');
        inLeadGroup=false; // the row itself marks a new group
        addRow('LEAD', msg, d);
        inLeadGroup=true;
      },
      numbers:(d)=> addRow('NUMBERS', `listed=${d.listedCount||0} extras=${d.extraCount||0} flagged=${d.flaggedCount||0}`, d),
      badge:(d)=>{
        // Update premium total
        const total = (d.totalPremium!=null ? Number(d.totalPremium) : NaN);
        if (!Number.isNaN(total)){
          badgeTotalEl.textContent = `$${total.toFixed(2)}`;
        }

        // Tally badge categories
        const b = (d.badge || '').trim();
        if (b.includes('⭐')) badgeTally.star++;
        else if (b.includes('⚪') || b.includes('○') || b.includes('●')) badgeTally.circle++;
        else badgeTally.other++;

        updateBadgeKpi();

        // Log line
        addRow('BADGE', `${b ? b+' ' : ''}total=${(d.totalPremium!=null? Number(d.totalPremium).toFixed(2) : '—')}`, d);
      },
      sheet:(d)=>{
        const url = d.url || d.msg || '';
        addRow('SHEET', url, {url});
      },
      error:(d)=> addRow('ERROR', d.msg || ''),
      done:(d)=> {
        addRow('DONE', '', d); // compact summary line
        inLeadGroup=false;
      },
      client:(d)=> addRow('INFO', d.msg || '')
    };

    ['info','start','lead','numbers','badge','sheet','error','done','client'].forEach(type=>{
      es.addEventListener(type, (e)=>{
        try{
          const data = JSON.parse(e.data || '{}');
          if (!t0 && type !== 'info') t0 = now();
          (handlers[type] || handlers.info)(data);
        }catch(err){
          console.error(err, e?.data);
          addRow('ERROR', 'parse error');
        }
      });
    });

    // Utils
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
    }
  </script>
</body>
</html>
