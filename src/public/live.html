<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Planet Lead Pull ‚Äî Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box }
    html, body { height: 100%; overflow-x: hidden; }
    body { margin: 0; font: 14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial; color: var(--fg); background: var(--bg); }

    header { position: sticky; top: 0; z-index: 50; background: var(--hdr-bg); backdrop-filter: blur(6px); border-bottom: 1px solid var(--line); box-shadow: 0 6px 16px rgba(0,0,0,.25); }
    .top { display:flex; align-items:center; gap:10px; padding:10px 12px; }
    .brand { font-weight: 800; letter-spacing: .4px }
    .ops { font-size: 12px; color: var(--muted) }
    .spacer{ flex:1 }

    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius: 10px; font-size: 12px; border:1px solid var(--chip-b); background: var(--chip); user-select: none; }
    .pill.link { border: none; background: transparent; padding: 0 2px; color: var(--muted); }
    .pill.link strong { color: var(--fg); font-weight: 700 }
    .dot { width:8px; height:8px; border-radius:999px; background: var(--ok) }

    #linkLed.ok .dot { animation: dotPulse 1600ms ease-in-out infinite; box-shadow: 0 0 0 0 color-mix(in oklab, var(--ok) 70%, transparent); }
    @keyframes dotPulse { 0%{transform:scale(1);box-shadow:0 0 0 0 color-mix(in oklab,var(--ok)40%,transparent)}70%{transform:scale(1.15);box-shadow:0 0 0 8px transparent}100%{transform:scale(1);box-shadow:0 0 0 0 transparent} }

    .toolbar { display:flex; flex-wrap: wrap; gap:8px; align-items:center; padding: 0 12px 10px 12px; }
    .input { padding:8px 10px; min-width:280px; border-radius:8px; border:1px solid var(--chip-b); background: var(--input); color:var(--fg); font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
    .btn { padding:6px 10px; border-radius:8px; border:1px solid var(--chip-b); background:var(--chip); cursor:pointer; color:var(--fg); }

    .chip { display:inline-flex; align-items:center; gap:6px; padding:5px 10px; border-radius:8px; font-size:12px; border:1px solid var(--chip-b); background:var(--chip); text-transform:none; letter-spacing:.02em; cursor:pointer; user-select: none; }
    .chip .dot { width:8px; height:8px; border-radius:999px; }
    .chip .dot.info { background: var(--c-info) }
    .chip[data-on="true"] { outline: 1px solid color-mix(in oklab, var(--c-info) 35%, transparent); box-shadow: 0 0 0 2px rgba(0,0,0,.15) inset; }

    .stats { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:12px; color: var(--muted); display:flex; align-items:center; gap:12px; }
    .stats .sep { opacity:.35 }
    .stats strong { color: var(--fg); font-weight:600 }

    .wrap { padding: 12px }
    .panel { border:none; border-radius:12px; background: var(--panel); box-shadow: none; padding: 8px 12px; min-height: calc(100dvh - 160px); }

    .group { margin: 6px 0 12px; padding: 4px 10px 8px 10px; border-radius: 12px;
      border: 1px solid color-mix(in oklab, var(--line) 90%, transparent);
      background: linear-gradient(180deg, rgba(255,255,255,.015), rgba(255,255,255,.02) 35%, transparent 100%);
      box-shadow: 0 0 0 1px rgba(255,255,255,.015) inset, 0 6px 20px rgba(0,0,0,.25);
    }

    /* rows: time | capsule | message */
    #log .row { position: relative; display:grid; grid-template-columns: 98px 110px 1fr; gap:12px; align-items:start; padding:10px 0; }
    .row.policy .msg { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
    .time { color: var(--time); font-variant-numeric: tabular-nums; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
    .type { display:none }
    .msg  { white-space: pre-wrap }

    .cap { justify-self:start; display:inline-flex; align-items:center; gap:6px;
      padding:3px 10px; border-radius:999px; font-size:11px; letter-spacing:.04em;
      border:1px solid var(--chip-b); background:var(--chip); text-transform:uppercase; color:var(--muted);
    }
    .cap.lead    { color: var(--c-lead);  background: color-mix(in oklab, var(--c-lead) 18%, transparent);  border-color: color-mix(in oklab, var(--c-lead) 55%, var(--chip-b)); }
    .cap.numbers { color: var(--c-num);   background: color-mix(in oklab, var(--c-num) 18%, transparent);   border-color: color-mix(in oklab, var(--c-num) 55%, var(--chip-b)); }
    .cap.badge   { color: var(--c-badge); background: color-mix(in oklab, var(--c-badge) 18%, transparent); border-color: color-mix(in oklab, var(--c-badge) 55%, var(--chip-b)); }
    .cap.sheet   { color: var(--c-sheet); background: color-mix(in oklab, var(--c-sheet) 18%, transparent); border-color: color-mix(in oklab, var(--c-sheet) 55%, var(--chip-b)); }
    .cap.info    { color: var(--c-info);  background: color-mix(in oklab, var(--c-info) 18%, transparent);  border-color: color-mix(in oklab, var(--c-info) 55%, var(--chip-b)); }
    .cap.policy  { color: var(--c-info);  background: color-mix(in oklab, var(--c-info) 18%, transparent);  border-color: color-mix(in oklab, var(--c-info) 55%, var(--chip-b)); }
    .cap.error   { color: var(--c-err);   background: color-mix(in oklab, var(--c-err) 18%, transparent);   border-color: color-mix(in oklab, var(--c-err) 55%, var(--chip-b)); }
    .cap.done    { color: var(--c-done);  background: color-mix(in oklab, var(--c-done) 18%, transparent);  border-color: color-mix(in oklab, var(--c-done) 55%, var(--chip-b)); }

    a.link { color: var(--c-sheet); text-decoration: none; border-bottom:1px dashed var(--c-sheet) }
    a.link:hover { text-decoration: underline }

    #log .row.newest::after{
      content:""; position:absolute; left:0; right:0; bottom:-2px; height:2px;
      background: linear-gradient(90deg, transparent 0%, color-mix(in oklab, var(--c-info) 0%, transparent) 30%, color-mix(in oklab, var(--c-info) 75%, transparent) 50%, color-mix(in oklab, var(--c-info) 0%, transparent) 70%, transparent 100%);
      opacity:.85; filter: blur(.2px); animation: sheenPulse 1600ms ease-in-out infinite;
    }
    @keyframes sheenPulse { 0%{opacity:.10;transform:translateX(-3%)}50%{opacity:.90;transform:translateX(0%)}100%{opacity:.10;transform:translateX(3%)} }

    /* ===== THEMES ===== */
    .t-aurora {
      --bg:#0b0f12; --panel: linear-gradient(180deg,#0e1317,#0b1014); --hdr-bg: rgba(11,15,18,.9);
      --fg:#e8eef6; --muted:#9fb0c2; --line:#1e2a34; --chip:#0f151b; --chip-b:#20303a; --input:#0e1419; --time:#b9c7d6;
      --c-info:#86b7ff; --c-start:#ffd27a; --c-lead:#a8ff8a; --c-num:#80ffc8; --c-badge:#f6b4ff; --c-sheet:#9ff2ff; --c-err:#ff7b7b; --c-done:#8ef0c9; --ok:#8fffa0;
    }
    .t-aurora::before { content:""; position:fixed; inset:0; pointer-events:none; mix-blend-mode:soft-light; opacity:.30;
      background: conic-gradient(from 0deg, rgba(80,180,255,.15), transparent 25%, rgba(120,255,170,.12), transparent 55%, rgba(255,220,120,.12), transparent 85%);
      filter: blur(22px); transform: scale(1.35); animation: neb 14s linear infinite;
    }
    @keyframes neb { to { transform: scale(1.35) rotate(360deg) } }

    .t-neon {
      --bg:#070b08; --panel: linear-gradient(180deg,#0a120e,#08100c); --hdr-bg: rgba(10,18,14,.9);
      --fg:#e7f3ea; --muted:#9aa69f; --line:#223429; --chip:#0d1611; --chip-b:#244033; --input:#0c1611; --time:#b7c5bb;
      --c-info:#8fffa0; --c-start:#ffd27a; --c-lead:#baff7e; --c-num:#80ffd1; --c-badge:#ffd2ff; --c-sheet:#9ff2ff; --c-err:#ff8b8b; --c-done:#8ef0c9; --ok:#8fffa0;
    }
    .t-neon::before { content:""; position:fixed; inset:0; pointer-events:none; opacity:.35;
      background: linear-gradient(180deg, rgba(255,255,255,.04) 1px, transparent 1px) 0 0/100% 3px, repeating-linear-gradient(0deg, transparent 0, transparent 22px, rgba(255,255,255,.028) 23px); }

    .t-matrix {
      --bg:#050805; --panel: linear-gradient(180deg,#071007,#060d06); --hdr-bg: rgba(6,12,7,.9);
      --fg:#d5f7d5; --muted:#8cab8c; --line:#103314; --chip:#0a160b; --chip-b:#1a3a1d; --input:#0a150b; --time:#99c699;
      --c-info:#7cff8f; --c-start:#c9ff72; --c-lead:#99ff66; --c-num:#66ffc2; --c-badge:#b3ffb3; --c-sheet:#66ffe0; --c-err:#ff6b6b; --c-done:#8ef0c9; --ok:#80ff99;
    }
    .t-matrix::before { content:""; position:fixed; inset:0; pointer-events:none; opacity:.2;
      background: radial-gradient(1200px 800px at 15% -10%, rgba(0,255,120,.10), transparent 60%), radial-gradient(1000px 900px at 110% 120%, rgba(0,180,120,.07), transparent 60%), repeating-linear-gradient(0deg, rgba(0,255,120,.04) 0 1px, transparent 1px 3px); }
    .t-matrix::after { content:""; position:fixed; inset:0; pointer-events:none; opacity:.07; background: repeating-linear-gradient(90deg, rgba(0,255,100,.35) 0 1px, transparent 1px 18px); mix-blend-mode: soft-light; }

    .t-light {
      --bg:#f8fafc; --panel:#ffffff; --hdr-bg:#ffffffcc; --fg:#0f172a; --muted:#475569; --line:#d4dbe3; --chip:#f1f5f9; --chip-b:#d7dee6; --input:#ffffff; --time:#334155;
      --c-info:#2563eb; --c-start:#b45309; --c-lead:#15803d; --c-num:#0e7490; --c-badge:#7c3aed; --c-sheet:#0ea5e9; --c-err:#b91c1c; --c-done:#047857; --ok:#16a34a;
    }

    /* highlight filter (Only ‚≠ê/üî¥) */
    body[data-highlights="on"] .group:not([data-badge-kind="star"]):not([data-badge-kind="red"]) { display:none; }

    #log, #log .row, #log .row * { mix-blend-mode: normal; filter: none; color: var(--fg) }

    /* toast */
    #toast { position: fixed; right: 16px; bottom: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 100; }
    .toast { background: var(--panel); border: 1px solid var(--line); color: var(--fg); padding: 10px 12px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,.35); font-size: 13px; }
    .toast a { color: var(--c-sheet); text-decoration: none; border-bottom: 1px dashed var(--c-sheet); }
  </style>
</head>
<body class="t-aurora">

  <header>
    <div class="top">
      <div class="brand">OP: PLANET LEAD PULL</div>
      <div class="ops">Live Feed</div>
      <div class="spacer"></div>

      <span id="linkLed" class="pill link" title="connection">
        <span class="dot" id="connDot" aria-hidden="true"></span> <strong>Connected</strong>
      </span>
    </div>

    <div class="toolbar" id="toolbar">
      <div class="stats" id="stats">
        <span id="badgeRun">‚≠ê 0 (0%) ‚ö™ 0 (0%) üü£ 0 (0%) üü† 0 (0%) üî¥ 0 (0%)</span>
        <span class="sep">|</span>
        <span id="premRun">$0 total premiums paid</span>
        <span class="sep">|</span>
        <span id="metaRun">‚è± <span id="elapsed">00:00:00</span> ¬∑ <span id="proc">0</span> leads</span>
      </div>

      <div class="spacer"></div>
      <input id="q" class="input" placeholder="Filter text (e.g. jobId, sheet:url)" />
      <button id="clearBtn" class="btn">Clear</button>
      <label class="chip" id="autoScroll" data-on="true" title="Auto-scroll on new messages"><span class="dot info"></span>Auto-scroll</label>
      <label class="chip" id="highlightsOnly" data-on="false" title="Show only ‚≠ê / üî¥ groups"><span class="dot info"></span>Only ‚≠ê/üî¥</label>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div id="log"></div>
    </div>
  </div>

  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* ---------- UI refs ---------- */
    const logEl = document.getElementById('log');
    const inputQ = document.getElementById('q');
    const autoScrollChip = document.getElementById('autoScroll');
    const highlightsChip = document.getElementById('highlightsOnly');
    const connDot = document.getElementById('connDot');
    const linkLed = document.getElementById('linkLed');
    const toastWrap = document.getElementById('toast');

    // running totals
    const badgeRunEl = document.getElementById('badgeRun');
    const premRunEl  = document.getElementById('premRun');
    const elapsedEl  = document.getElementById('elapsed');
    const procEl     = document.getElementById('proc');

    /* ---------- filter + controls ---------- */
    const toggleChip = (chipEl) => chipEl.dataset.on = chipEl.dataset.on === 'true' ? 'false' : 'true';

    autoScrollChip.addEventListener('click', () => toggleChip(autoScrollChip));
    highlightsChip.addEventListener('click', () => {
      toggleChip(highlightsChip);
      document.body.dataset.highlights = highlightsChip.dataset.on === 'true' ? 'on' : 'off';
    });

    document.getElementById('clearBtn').onclick = () => { logEl.innerHTML=''; currentGroup = null; };
    inputQ.addEventListener('input', ()=> refilter());

    function refilter(){
      const q = inputQ.value.trim().toLowerCase();
      [...logEl.querySelectorAll('.row')].forEach(row=>{
        row.style.display = !q || row.innerText.toLowerCase().includes(q) ? '' : 'none';
      });
    }

    /* ---------- helpers ---------- */
    const params = new URLSearchParams(location.search);
    const jobId = params.get('job') || null;

    let t0 = null;
    const now = () => performance.now();
    const pad2 = n => String(n).padStart(2,'0');
    const hmsFromMs = (ms) => {
      const s = Math.max(0, Math.floor(ms/1000));
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
      return (h? h+'h ' : '') + (m? m+'m ' : '') + (ss? ss+'s' : '0s');
    };
    const elapsedHMS = () => {
      if (!t0) return '00:00:00';
      const d = now()-t0;
      const hh = pad2(Math.floor(d/3600000));
      const mm = pad2(Math.floor((d%3600000)/60000));
      const ss = pad2(Math.floor((d%60000)/1000));
      return `${hh}:${mm}:${ss}`;
    };
    setInterval(() => { elapsedEl.textContent = elapsedHMS(); }, 1000);

    // grouping per lead
    let currentGroup = null;
    let processed = 0;

    function startGroup() {
      currentGroup = document.createElement('div');
      currentGroup.className = 'group';
      logEl.appendChild(currentGroup);
    }
    function hostFor(level){
      if (level === 'lead') { startGroup(); policyIdx = 0; return currentGroup; }
      if (currentGroup && (level === 'numbers' || level === 'badge' || level === 'info' || level === 'policy' || level === 'sheet')) return currentGroup;
      return logEl;
    }

    function makeCap(level, labelOverride){
      const c = document.createElement('span');
      c.className = `cap ${level}`;
      c.textContent = (labelOverride || level).toUpperCase();
      return c;
    }

    function addRow(level, msg, meta = {}) {
      const q = inputQ.value.trim().toLowerCase();
      if (q && !(`${level} ${JSON.stringify(meta)} ${msg}`.toLowerCase().includes(q))) return;

      const wasNewest = logEl.querySelector('.row.newest');
      if (wasNewest) wasNewest.classList.remove('newest');

      const row = document.createElement('div');
      row.className = 'row newest';
      row.classList.add(level);

      const t = document.createElement('div');
      t.className = 'time'; t.textContent = elapsedHMS();

      const ty = document.createElement('div'); ty.className = 'type';
      const lvl = document.createElement('span'); lvl.className = `level-${level}`; lvl.textContent = level;
      ty.append(lvl);

      const cap = makeCap(level, meta.capLabel);

      const m = document.createElement('div');
      m.className = 'msg';
      if (meta.html) { m.innerHTML = meta.html; } else { m.textContent = msg; }

      row.append(t, cap, m, ty);
      hostFor(level).appendChild(row);

      if (autoScrollChip.dataset.on === 'true') { row.scrollIntoView({behavior:'smooth', block:'end'}); }
    }

    /* ---------- Running totals ---------- */
    let totalBadged = 0;
    const counts = { star:0, purple:0, orange:0, red:0, white:0 };
    let packPremiumTotal = 0;

    function fmtPct(n, d) { return d ? Math.round((n/d)*100) + '%' : '0%'; }
    function renderStats() {
      badgeRunEl.textContent =
        `‚≠ê ${counts.star} (${fmtPct(counts.star,totalBadged)}) ` +
        `‚ö™ ${counts.white} (${fmtPct(counts.white,totalBadged)}) ` +
        `üü£ ${counts.purple} (${fmtPct(counts.purple,totalBadged)}) ` +
        `üü† ${counts.orange} (${fmtPct(counts.orange,totalBadged)}) ` +
        `üî¥ ${counts.red} (${fmtPct(counts.red,totalBadged)})`;

      const rounded = Math.round(packPremiumTotal);
      premRunEl.textContent = `${rounded.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0})} total premiums paid`;
      procEl.textContent = processed;
    }
    function classifyBadge(txt){
      const t = (txt||'').toString().toLowerCase();
      if (/[‚≠ê]|star|prem/.test(t)) return 'star';
      if (/purple|üü£/.test(t))     return 'purple';
      if (/orange|üü†/.test(t))     return 'orange';
      if (/red|üî¥/.test(t))        return 'red';
      if (/white|‚ö™|basic/.test(t))return 'white';
      return 'white';
    }
    function badgeEmoji(kind){
      return kind === 'star' ? '‚≠ê' :
             kind === 'purple' ? 'üü£' :
             kind === 'orange' ? 'üü†' :
             kind === 'red' ? 'üî¥' : '‚ö™';
    }

    /* ---------- text transforms ---------- */
    const ord = n => {
      const s = ["th","st","nd","rd"], v = n%100;
      return n + (s[(v-20)%10] || s[v] || s[0]);
    };

    let policyIdx = 0;

    // returns string OR { level, text, html }
    function transformInfo(raw, data){
      const s = (raw||'').trim();
      const low = s.toLowerCase();

      // hide noisy echos
      if (low.startsWith('lead: opening')) return null;
      if (low.startsWith('sheet:url'))     return null;

      // secure/privacy tone for early lines
      if (low.startsWith('stream: connected'))  return `Private channel active${jobId ? ` (job: ${jobId})` : ''}`;
      if (low.startsWith('client: subscribed')) return 'Client: Token verified, feed granted';
      if (low.startsWith('client: connected'))  return 'Client: Ready';

      // Browser/Login rephrasing
      if (low.startsWith('browser: ready'))  return 'Browser: Ready';
      if (low.startsWith('login: starting')) return 'Login: Starting';
      if (low.startsWith('login: ok'))       return '‚úÖLogin';

      // badge config confirmation (new)
      if (low.startsWith('badge:config')) {
        // expect: 'badge:config {"order":[...],"priority":{...}}'
        const m = s.match(/badge:config\s+(.+)$/i);
        if (m) {
          try {
            const obj = JSON.parse(m[1]);
            const ord = Array.isArray(obj.order) ? obj.order.join(' > ') : 'star,white,purple,orange,red';
            const lFirst = obj?.priority?.lapsedFirst !== false;
            return `Badge config received ¬∑ order: ${ord} ¬∑ lapsedFirst: ${lFirst ? 'yes' : 'no'}`;
          } catch {}
        }
        return 'Badge config received';
      }

      // nav
      if (/\bgo to all leads\b/i.test(s)) return '‚û°Ô∏èGo to All Leads';
      if (/^go to next page$/i.test(s))  return '‚û°Ô∏èGo to next page';

      // header fallback notice
      if (/listed#:\s*header fallback used/i.test(s)) return 'Listed #: header fallback used';

      // mailbox/pack events
      const mSize = /setPageSize\((\d+)\)/i.exec(s);
      if (mSize) return `üì¨Page Size: Set (${mSize[1]})`;
      if (/inbox loaded/i.test(s)) return 'üì¨Pack Loaded';

      const mPageOf = /page\s+(\d+)\s+of\s+~?(\d+)/i.exec(s);
      if (mPageOf) return `üì¨Page ${mPageOf[1]} of ${mPageOf[2]}`;

      const mCollected = /collected\s+(\d+)\s+links on page\s+(\d+),\s*total\s+(\d+)/i.exec(s);
      if (mCollected) return `üì¨Page ${mCollected[2]}: ${mCollected[1]} links collected (total: ${mCollected[3]})`;

      // POLICY pretty print from "lapse: ..."
      if (low.startsWith('lapse:')) {
        policyIdx += 1;

        const mode    = /mode\s*=\s*([a-z]+)/i.exec(s)?.[1] || 'monthly';
        const cushion = /cushion\s*=\s*(\d+)d/i.exec(s)?.[1] || '31';
        const dueRaw  = /dueDay\s*=\s*([0-9]{1,2}|N\/A|NA)/i.exec(s)?.[1] || null;
        const normM   = /->\s*norm\s*=\s*(\d+)/i.exec(s);
        const normDue = normM ? Number(normM[1]) : null;
        const statusM = /status\s*=\s*(lapsed|active)/i.exec(s);
        const status  = statusM ? statusM[1].toLowerCase() : null;

        const isLapsed =
          data?.isLapsed === true ||
          status === 'lapsed' ||
          /\blapsed\b/i.test(s) ||
          /\bpast\s*due\b/i.test(s) ||
          /\boverdue\b/i.test(s);

        const dayNum = (typeof normDue === 'number' && Number.isFinite(normDue))
          ? normDue
          : (dueRaw && /^\d+$/.test(dueRaw) ? Number(dueRaw) : null);

        const dueText = (dayNum != null) ? ord(dayNum) : (dueRaw || 'N/A');

        const base = `Policy ${policyIdx} | Mode: ${mode.charAt(0).toUpperCase()+mode.slice(1)}, Due Day: ${dueText}, Grace: ${cushion}d`;
        const text = isLapsed ? `${base} <span style="color:#ff4d4d">(Lapsed)</span>` : base;

        return { level: 'policy', text, html: isLapsed };
      }

      const mDone = /^session:\s*done\b(.*)$/i.exec(s);
      if (mDone) {
        const tail = (mDone[1] || '').trim();
        return `Session: Done${tail ? ' ' + tail : ''}`;
      }

      return s;
    }

    /* ---------- SSE ---------- */
    const es = new EventSource(jobId ? `/events?jobId=${encodeURIComponent(jobId)}` : '/events');

    es.addEventListener('open', () => {
      connDot.style.background = 'var(--ok)';
      linkLed.classList.add('ok');
      if (!t0) t0 = now();
      addRow('info', `Private channel active${jobId ? ` (job: ${jobId})` : ''}`);
    });

    es.addEventListener('error', () => {
      linkLed.classList.remove('ok');
      connDot.style.background = 'var(--c-err)';
      addRow('error', 'stream: error (trying to reconnect‚Ä¶)');
    });

    const handlers = {
      info: (d) => {
        const out = transformInfo(d?.msg || '', d);
        if (out == null) return;

        if (typeof out === 'string') {
          const useHtml = /<span\b/i.test(out);
          addRow('info', out, useHtml ? { html: out } : {});
          return;
        }

        const level = out.level || 'info';
        addRow(level, out.text, out.html ? { html: out.text, capLabel: level } : { capLabel: level });
      },

      start: (d) => { if (!t0) t0 = now(); addRow('start', `max=${d.maxLeads ?? ''}`, d); },

      lead: (d) => {
        let name = d.leadName || d.name || d.msg || '';
        const h = /^#?(\d+)\s*\/\s*(\d+)\s+(.+)$/i.exec(name);
        if (h) { const [, i, tot, nm] = h; name = `${nm.trim()} (${i} of ${tot})`; }
        else if (d.index && d.total && name) { name = `${name} (${d.index} of ${d.total})`; }
        addRow('lead', `üìÅ${name || (d.msg || '')}`);
        policyIdx = 0;
      },

      numbers: (d) => {
        const msg = `Listed: ${d.listedCount}  Extras: ${d.extraCount}  Flagged: ${d.flaggedCount}`;
        addRow('numbers', msg);
      },

      badge: (d) => {
        totalBadged += 1;
        const kind = classifyBadge(d.badge);
        counts[kind] = (counts[kind] || 0) + 1;

        const leadTotal = Number(d.totalPremium || 0);
        packPremiumTotal += isFinite(leadTotal) ? leadTotal : 0;
        renderStats();

        if (currentGroup) currentGroup.dataset.badgeKind = kind;

        const msg = `Total Premium: ${leadTotal.toLocaleString(undefined,{style:'currency',currency:'USD'})} ${badgeEmoji(kind)}`;
        addRow('badge', msg);

        currentGroup = null;
      },

      sheet: (d) => {
        if (!d.url) return;
        addRow('sheet', '', { html: `üìäsheet: <a class="link" href="${d.url}" target="_blank" rel="noopener">${d.url}</a>` });
      },

      sheet_done: (d) => {
        if (!d?.url) return;
        const div = document.createElement('div');
        div.className = 'toast';
        div.innerHTML = `‚úÖ Sheet ready: <a href="${d.url}" target="_blank" rel="noopener">open</a>` +
                        (d.spreadsheetId ? ` <small>(id: ${d.spreadsheetId})</small>` : '');
        toastWrap.appendChild(div);
        setTimeout(() => { try { toastWrap.removeChild(div); } catch {} }, 7000);
      },

      error: (d) => addRow('error', d.msg || ''),

      done: (d) => {
        if (!d || (typeof d.processed === 'number' && d.processed === 0)) return;
        const human = (typeof d.ms === 'number') ? hmsFromMs(d.ms) : '';
        processed = Number(d.processed || processed);
        renderStats();
        addRow('done', `üèÅ${d.processed ?? 0} ${d.processed === 1 ? 'lead' : 'leads'} processed in ${human || '0s'}`);
        currentGroup = null;
      },

      client:  (d) => addRow('client', d.msg || '')
    };

    ['info','start','lead','numbers','badge','sheet','sheet_done','error','done','client'].forEach(type=>{
      es.addEventListener(type, (e)=>{
        try{
          const data = JSON.parse(e.data || '{}');
          if (!t0 && type !== 'info') t0 = now();
          (handlers[type] || handlers.info)(data);
        }catch(err){
          addRow('error', 'parse error');
          console.error(err, e?.data);
        }
      });
    });

    renderStats();
  </script>
</body>
</html>
