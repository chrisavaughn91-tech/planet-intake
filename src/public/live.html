<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planet Intake — Live</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111926;
      --muted: #8aa0b4;
      --fg: #e7eef7;
      --accent: #86b7ff;

      --info:  #8aa0b4;   /* slate */
      --lead:  #ffd166;   /* amber */
      --sheet: #33d17a;   /* green */
      --error: #ff6b6b;   /* red */
      --done:  #cdb4ff;   /* purple */
    }
    html,body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .bar {
      display: flex; align-items: center; gap: 12px;
      background: var(--card); border-radius: 12px; padding: 10px 12px; margin-bottom: 10px;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--error); box-shadow: 0 0 0 2px #0003; }
    .dot.ok    { background: #2ecc71; }
    .dot.wait  { background: #f1c40f; }
    .bar small { color: var(--muted); }
    .legend { margin-left: auto; display: flex; gap: 10px; flex-wrap: wrap; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 2px 8px; border-radius: 999px; background: #ffffff10; color: var(--fg);
      border: 1px solid #ffffff12; font-size: 12px;
    }
    .sw { width: 10px; height: 10px; border-radius: 2px; background: var(--muted); }
    .sw.info  { background: var(--info); }
    .sw.lead  { background: var(--lead); }
    .sw.sheet { background: var(--sheet); }
    .sw.error { background: var(--error); }
    .sw.done  { background: var(--done); }

    .log {
      background: var(--card); border-radius: 12px; padding: 4px 0; overflow: auto; max-height: calc(100vh - 140px);
      border: 1px solid #ffffff0f;
    }
    .row {
      display: grid; grid-template-columns: 140px 100px 1fr; gap: 14px;
      padding: 8px 12px; border-bottom: 1px solid #ffffff08;
    }
    .row:last-child { border-bottom: none; }
    .ts { color: var(--muted); font-variant-numeric: tabular-nums; }
    .ev { color: var(--muted); }

    /* colorize by type */
    .row.info  .ev { color: var(--info); }
    .row.lead  .ev { color: var(--lead); }
    .row.sheet .ev { color: var(--sheet); }
    .row.error .ev { color: var(--error); }
    .row.done  .ev { color: var(--done); }

    .msg code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #00000030; padding: 0 4px; border-radius: 4px;
    }

    /* START:COMPACT-MSG-CSS */
    .col-msg {
      max-width: calc(100% - 280px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* END:COMPACT-MSG-CSS */

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div id="dot" class="dot"></div>
      <div id="status">Connecting…</div>
      <small id="attempt"></small>
      <div class="legend" aria-label="Legend">
        <span class="pill"><span class="sw info"></span>info</span>
        <span class="pill"><span class="sw lead"></span>lead</span>
        <span class="pill"><span class="sw sheet"></span>sheet</span>
        <span class="pill"><span class="sw error"></span>error</span>
        <span class="pill"><span class="sw done"></span>done</span>
      </div>
    </div>
    <table id="log" class="log" role="log" aria-live="polite"><tbody></tbody></table>
  </div>

  <script>
    // ========= util =========
    const dot = document.getElementById('dot');
    const statusEl = document.getElementById('status');
    const attemptEl = document.getElementById('attempt');

    /* === COMPACT-MSG-HELPERS === */
    const HIDE_KEYS = new Set(['ts','_raw','execUrlPrefix','href']);

    function compactMsg(obj) {
      try {
        if (obj == null) return '';
        if (typeof obj === 'string') return obj;

        // Friendly shortcuts
        if (obj.message) return String(obj.message);
        if (obj.type === 'hello') return 'hello';
        if (obj.type === 'heartbeat') return 'heartbeat';

        // Lead-style summaries
        if (obj.lead) {
          if (typeof obj.lead === 'string') return obj.lead;
          if (obj.leadName) return String(obj.leadName);
        }
        if (obj.badge && typeof obj.badge === 'string' && obj.totalPremium != null) {
          return `badge: ${obj.badge}, totalPremium=${obj.totalPremium}`;
        }
        if (obj.numbers && typeof obj.index === 'number') {
          return `lead ${obj.index}: monthly=${obj.monthly ?? '?'} listed=${obj.listed ?? '?'} extras=${obj.extraCount ?? 0}`;
        }

        // Generic: pick simple fields, drop noisy/internal
        const flat = [];
        for (const [k,v] of Object.entries(obj)) {
          if (HIDE_KEYS.has(k) || k.startsWith('_')) continue;
          if (typeof v === 'object') continue;
          flat.push(`${k}=${v}`);
        }
        if (flat.length) return flat.join(', ');

        // Last resort
        return JSON.stringify(obj);
      } catch {
        try { return JSON.stringify(obj); } catch { return String(obj); }
      }
    }
    /* === END COMPACT-MSG-HELPERS === */

    function appendRow(kind, data) {
      // ensure table exists
      const tbody = document.querySelector('#log tbody');
      const tr = document.createElement('tr');
      tr.className = kind;

      const tds = [document.createElement('td'), document.createElement('td'), document.createElement('td')];
      const now = new Date();
      tds[0].textContent = now.toLocaleTimeString('en-US', { hour12:false });
      tds[1].textContent = kind;

      const visible = compactMsg(data);
      tds[2].textContent = visible;

      // Keep full JSON in tooltip
      try { tds[2].title = JSON.stringify(data); } catch { /* ignore */ }

      tds.forEach(td => tr.appendChild(td));
      tbody.appendChild(tr);
    }

    // ========= SSE with auto-reconnect =========
    const ENDPOINT = (window.__EVENTS_URL__ || '/events');

    let es = null;
    let backoff = 1000;         // 1s -> 2s -> 4s -> … -> 10s
    const MAX_BACKOFF = 10000;

    function setState(kind, detail='') {
      dot.classList.remove('ok','wait');
      if (kind === 'ok') dot.classList.add('ok');
      if (kind === 'wait') dot.classList.add('wait');
      statusEl.textContent = (kind === 'ok') ? 'Connected' : (kind === 'wait') ? 'Reconnecting…' : 'Disconnected';
      attemptEl.textContent = detail;
    }

    // START:ROUTE-EVENT-COMPACT
    function routeEvent(e) {
      const obj = JSON.parse(e.data);
      appendRow(e.type || 'info', obj);
    }
    // END:ROUTE-EVENT-COMPACT

    function connect() {
      if (es) try { es.close(); } catch {}
      es = new EventSource(ENDPOINT, { withCredentials: false });

      es.onopen = () => {
        setState('ok');
        backoff = 1000; // reset backoff on healthy connect
        appendRow('info', { message: 'connected to ' + ENDPOINT });
      };

      // default messages
      es.onmessage = (e) => routeEvent(e);

      // named event handlers we care about (no-ops if server doesn’t emit them)
      ['info','lead','sheet','error','done'].forEach((t) => {
        es.addEventListener(t, routeEvent);
      });

      es.onerror = () => {
        setState('wait', `retry in ${Math.round(backoff/1000)}s`);
        appendRow('error', { message: 'event stream error; reconnecting…' });
        try { es.close(); } catch {}
        setTimeout(connect, backoff + Math.floor(Math.random()*400)); // jitter
        backoff = Math.min(MAX_BACKOFF, backoff * 2);
      };
    }

    // kick it off
    connect();

    // Optional: when tab is hidden for a long period and the connection drops,
    // try a quick reconnect on visibilitychange.
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && es && es.readyState === EventSource.CLOSED) {
        connect();
      }
    });
  </script>
</body>
</html>
