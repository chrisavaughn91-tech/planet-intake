<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Planet Lead Pull — Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{color-scheme:dark; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;}
    body{margin:0; background:#0f1620; color:#e7eef7;}
    header{position:sticky; top:0; background:#0f1620; border-bottom:1px solid #1f2a37; padding:10px 14px; display:flex; gap:12px; align-items:center;}
    header .meta{margin-left:auto; opacity:.8; font-size:12px}
    .btn{background:#111a24; color:#e7eef7; border-radius:8px; padding:6px 10px; cursor:pointer; font-size:12px; border:1px dashed #1f2a37;}
    .row{display:grid; grid-template-columns:84px 84px 1fr; gap:10px; padding:4px 10px; border-bottom:1px dashed #1f2a37;}
    .row .ts{opacity:.7}
    .row.info  .type{color:#8ab4ff}
    .row.start .type{color:#b6f09c}
    .row.lead  .type{color:#ffd166}
    .row.error .type{color:#ff6b6b}
    .indent{padding-left:18px}
    #log{padding-bottom:60vh}
    a{color:#8ab4ff}
  </style>
</head>
<body>
  <header>
    <input id="filter" placeholder="Filter text (e.g. start, lead, sheet, error)" class="btn" style="flex:1" />
    <label class="btn"><input id="auto" type="checkbox" checked /> auto-scroll</label>
    <button id="clear" class="btn">Clear</button>
    <button id="copy"  class="btn">Copy last 200</button>
    <div id="meta" class="meta"></div>
  </header>

  <div id="log" role="log" aria-live="polite"></div>

  <script>
    // --- helpers ---
    const $ = sel => document.querySelector(sel);
    const filterEl = $('#filter');
    const autoEl   = $('#auto');
    const logEl    = $('#log');
    const metaEl   = $('#meta');

    const params = new URLSearchParams(location.search);
    // Accept either ?job= or ?jobId=, but normalize to job
    const jobId = params.get('job') || params.get('jobId') || '';

    let startAt = performance.now();
    let lastLeadGroup = null;

    function fmt(t){
      const ms = Math.max(0, t - startAt);
      const s  = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }
    function passesFilter(text){
      const f = filterEl.value.trim().toLowerCase();
      return !f || text.toLowerCase().includes(f);
    }
    function maybeScroll(){
      if (autoEl.checked) logEl.lastElementChild?.scrollIntoView({behavior:'smooth', block:'end'});
    }

    function makeRow(type, text, cls=''){
      const row = document.createElement('div');
      row.className = `row ${type} ${cls}`.trim();
      const ts = document.createElement('div'); ts.className='ts';   ts.textContent = fmt(performance.now());
      const ty = document.createElement('div'); ty.className='type'; ty.textContent = type;
      const msg = document.createElement('div'); msg.className='msg'; msg.textContent = text;
      row.append(ts,ty,msg);
      return row;
    }
    function addRow(type, text, cls=''){
      if (!passesFilter(`${type} ${text}`)) return;
      const row = makeRow(type, text, cls);
      if (type === 'lead') {
        lastLeadGroup = row;
        logEl.appendChild(row);
      } else if (lastLeadGroup) {
        const wrap = document.createElement('div');
        wrap.className = 'indent';
        wrap.appendChild(row);
        logEl.appendChild(wrap);
      } else {
        logEl.appendChild(row);
      }
      maybeScroll();
    }

    $('#clear').addEventListener('click', ()=>{ logEl.innerHTML=''; lastLeadGroup=null; });
    $('#copy').addEventListener('click', ()=>{
      const nodes = Array.from(logEl.children).slice(-200);
      const text = nodes.map(n => n.innerText.replace(/\n+/g,'  ')).join('\n');
      navigator.clipboard.writeText(text).catch(()=>{});
    });

    metaEl.textContent = jobId ? `Live stream for job ${jobId}` : `Live stream (no job — showing all events)`;

    // *** IMPORTANT: use ?job= (not ?jobId=). We still accept jobId on the server, but normalize here. ***
    const es = new EventSource(`/events${jobId ? `?job=${encodeURIComponent(jobId)}` : ''}`);

    es.addEventListener('open',  ()=> addRow('info','stream: connected','ok'));
    es.addEventListener('error', ()=> addRow('error','stream: disconnected','err'));

    const handlers = {
      info:   d => addRow('info',   d.msg ?? JSON.stringify(d)),
      start:  d => addRow('start',  d.msg ?? JSON.stringify(d)),
      lead:   d => addRow('lead',   d.msg ?? (d.company ? `${d.company} — ${d.contact || ''}` : JSON.stringify(d))),
      sheet:  d => addRow('sheet',  d.url ? `Sheet created: ${d.url}` : JSON.stringify(d)),
      done:   d => addRow('done',   JSON.stringify(d), 'ok'),
      error:  d => addRow('error',  d.msg ?? JSON.stringify(d), 'err'),
    };

    for (const t of Object.keys(handlers)) {
      es.addEventListener(t, ev => {
        try { handlers[t](JSON.parse(ev.data||'{}')); }
        catch { addRow('error', `bad event data for ${t}`); }
      });
    }
  </script>
</body>
</html>
